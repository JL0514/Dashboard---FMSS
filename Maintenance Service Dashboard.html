<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Dashboard - Corporate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            500: '#334155',
                            600: '#1e293b',
                            700: '#0f172a',
                            900: '#020617'
                        },
                        accent: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        },
                        success: {
                            50: '#f0fdf4',
                            500: '#10b981',
                            600: '#059669'
                        },
                        warning: {
                            50: '#fffbeb',
                            500: '#f59e0b',
                            600: '#d97706'
                        },
                        danger: {
                            50: '#fef2f2',
                            500: '#ef4444',
                            600: '#dc2626'
                        }
                    },
                    fontFamily: {
                        'corporate': ['Inter', 'system-ui', '-apple-system', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        
        /* Corporate Minimalist Theme */
        :root {
            --corporate-primary: #334155;
            --corporate-secondary: #64748b;
            --corporate-accent: #3b82f6;
            --corporate-success: #10b981;
            --corporate-warning: #f59e0b;
            --corporate-danger: #ef4444;
            --corporate-bg: #ffffff;
            --corporate-surface: #f8fafc;
            --corporate-border: #e2e8f0;
            --corporate-text: #1e293b;
            --corporate-text-light: #64748b;
        }
        
        .dark {
            --corporate-primary: #64748b;
            --corporate-secondary: #475569;
            --corporate-accent: #60a5fa;
            --corporate-success: #34d399;
            --corporate-warning: #fbbf24;
            --corporate-danger: #f87171;
            --corporate-bg: #0f172a;
            --corporate-surface: #1e293b;
            --corporate-border: #334155;
            --corporate-text: #f1f5f9;
            --corporate-text-light: #94a3b8;
        }
        
        body {
            background: var(--corporate-bg);
            color: var(--corporate-text);
        }
        
        /* Navigation Sidebar - Corporate Style */
        .nav-sidebar {
            width: 280px;
            min-width: 280px;
            background: var(--corporate-primary);
            border-right: 1px solid var(--corporate-border);
            transition: all 0.3s ease;
        }

        .nav-sidebar.collapsed {
            width: 80px;
            min-width: 80px;
        }

        .nav-sidebar.hidden-desktop {
            transform: translateX(-100%);
            opacity: 0;
        }

        .sidebar-toggle-btn {
            position: fixed;
            top: 20px;
            left: 300px;
            z-index: 1001;
            background: var(--corporate-primary);
            color: white;
            border: 1px solid var(--corporate-border);
            width: 44px;
            height: 44px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sidebar-toggle-btn:hover {
            background: var(--corporate-secondary);
            transform: translateY(-1px);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 6px;
            margin: 2px 12px;
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(2px);
        }

        .nav-item.active {
            background: var(--corporate-accent);
            color: white;
        }

        .nav-sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 14px;
        }

        .nav-sidebar.collapsed .nav-text {
            display: none;
        }

        /* Corporate Button Styles */
        .btn-primary {
            background: var(--corporate-primary);
            color: white;
            border: 1px solid transparent;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            background: var(--corporate-secondary);
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: var(--corporate-success);
            color: white;
            border: 1px solid transparent;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }
        
        .btn-info {
            background: var(--corporate-accent);
            color: white;
            border: 1px solid transparent;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-info:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: var(--corporate-danger);
            color: white;
            border: 1px solid transparent;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }
        
        .btn-warning {
            background: var(--corporate-warning);
            color: white;
            border: 1px solid transparent;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-1px);
        }
        
        /* Corporate Card Style */
        .card {
            background: var(--corporate-bg);
            border: 1px solid var(--corporate-border);
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .dark .card {
            background: var(--corporate-surface);
            border-color: var(--corporate-border);
        }
        
        /* Corporate Form Elements */
        .form-input {
            border: 1px solid var(--corporate-border);
            border-radius: 6px;
            background: var(--corporate-bg);
            color: var(--corporate-text);
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            border-color: var(--corporate-accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }
        
        .dark .form-input {
            background: var(--corporate-surface);
            border-color: var(--corporate-border);
            color: var(--corporate-text);
        }

        /* Corporate Section Styling */
        .maintenance-section {
            background: var(--corporate-bg);
            border: 1px solid var(--corporate-border);
            border-radius: 8px;
            padding: 24px;
            transition: all 0.2s ease;
        }

        .dark .maintenance-section {
            background: var(--corporate-surface);
            border-color: var(--corporate-border);
        }

        .maintenance-section:hover {
            border-color: var(--corporate-accent);
            transform: translateY(-1px);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--corporate-border);
        }

        .section-icon {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        /* Corporate Metric Cards */
        .metric-card {
            background: var(--corporate-surface);
            border: 1px solid var(--corporate-border);
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .dark .metric-card {
            background: var(--corporate-surface);
            border-color: var(--corporate-border);
        }

        .metric-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* Corporate Table Styling - Enhanced for Better Alignment */
        .table-container {
            border: 1px solid var(--corporate-border);
            border-radius: 8px;
            overflow: auto;
            max-width: 100%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .excel-table {
            border-collapse: collapse;
            font-size: 0.875rem;
            width: 100%;
            min-width: 1400px;
            table-layout: fixed;
            background: var(--corporate-bg);
        }

        .excel-table th {
            background: var(--corporate-primary);
            color: white;
            font-weight: 600;
            text-align: center;
            padding: 12px 8px;
            border: 1px solid var(--corporate-border);
            vertical-align: middle;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .excel-table td {
            border: 1px solid var(--corporate-border);
            padding: 8px 6px;
            text-align: center;
            background: var(--corporate-bg);
            color: var(--corporate-text);
            vertical-align: middle;
            white-space: nowrap;
            font-size: 0.8rem;
            line-height: 1.2;
        }

        .dark .excel-table {
            background: var(--corporate-surface);
        }

        .dark .excel-table td {
            background: var(--corporate-surface);
            color: var(--corporate-text);
        }

        .excel-table .category-header {
            background: var(--corporate-surface) !important;
            font-weight: 600;
            text-align: left !important;
            padding-left: 16px !important;
            color: var(--corporate-text) !important;
            border-right: 2px solid var(--corporate-accent) !important;
            width: 200px;
            min-width: 200px;
            max-width: 200px;
        }

        .excel-table .type-header {
            background: var(--corporate-surface) !important;
            color: var(--corporate-text) !important;
            text-align: left !important;
            padding-left: 12px !important;
            width: 140px;
            min-width: 140px;
            max-width: 140px;
            font-weight: 500;
        }

        .excel-table .month-header {
            width: 90px;
            min-width: 90px;
            max-width: 90px;
            text-align: center !important;
            line-height: 1.1;
        }

        .excel-table .total-header {
            background: var(--corporate-success) !important;
            width: 120px;
            min-width: 120px;
            max-width: 120px;
            font-weight: 700;
        }

        .excel-table .total-row {
            background: var(--corporate-primary) !important;
            color: white !important;
            font-weight: 600 !important;
        }

        .excel-table .total-row td {
            background: var(--corporate-primary) !important;
            color: white !important;
            font-weight: 600 !important;
        }

        /* Corporate Performance Indicators */
        .performance-excellent { 
            background-color: #dcfce7 !important; 
            color: #166534 !important; 
            font-weight: 600;
        }
        .performance-good { 
            background-color: #fef3c7 !important; 
            color: #92400e !important; 
            font-weight: 600;
        }
        .performance-poor { 
            background-color: #fecaca !important; 
            color: #991b1b !important; 
            font-weight: 600;
        }

        .dark .performance-excellent { 
            background-color: #166534 !important; 
            color: #dcfce7 !important; 
        }
        .dark .performance-good { 
            background-color: #92400e !important; 
            color: #fef3c7 !important; 
        }
        .dark .performance-poor { 
            background-color: #991b1b !important; 
            color: #fecaca !important; 
        }

        /* Corporate Chart Styling */
        .chart-container {
            background: var(--corporate-bg);
            border: 1px solid var(--corporate-border);
            border-radius: 8px;
            position: relative;
            min-height: 300px;
            height: 400px;
            width: 100%;
        }
        
        .dark .chart-container {
            background: var(--corporate-surface);
        }

        /* Corporate Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-issued {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .status-returned {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .dark .status-issued {
            background-color: #92400e;
            color: #fef3c7;
            border: 1px solid #f59e0b;
        }

        .dark .status-returned {
            background-color: #166534;
            color: #dcfce7;
            border: 1px solid #10b981;
        }

        /* Priority badges */
        .priority-low {
            background-color: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .priority-medium {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .priority-high {
            background-color: #fecaca;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .priority-critical {
            background-color: #7f1d1d;
            color: #fecaca;
            border: 1px solid #dc2626;
        }

        .dark .priority-low {
            background-color: #374151;
            color: #f3f4f6;
            border: 1px solid #6b7280;
        }

        /* Corporate Modal Styling */
        .modal-dialog {
            background: var(--corporate-bg);
            border: 1px solid var(--corporate-border);
            border-radius: 8px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .dark .modal-dialog {
            background: var(--corporate-surface);
            border-color: var(--corporate-border);
        }

        /* Corporate Summary Controls */
        .summary-controls {
            background: var(--corporate-surface);
            border: 1px solid var(--corporate-border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .dark .summary-controls {
            background: var(--corporate-surface);
            border-color: var(--corporate-border);
        }

        /* Corporate Typography */
        h1, h2, h3, h4, h5, h6 {
            color: var(--corporate-text);
            font-weight: 600;
        }

        .text-corporate-primary {
            color: var(--corporate-primary) !important;
        }

        .text-corporate-secondary {
            color: var(--corporate-secondary) !important;
        }

        .bg-corporate-primary {
            background-color: var(--corporate-primary) !important;
        }

        .bg-corporate-surface {
            background-color: var(--corporate-surface) !important;
        }

        /* Corporate Grid Layout */
        .section-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        /* Corporate Animation */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Auto-save indicator - Corporate style */
        .auto-save-indicator {
            background: var(--corporate-success);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Main content adjustment */
        .main-content {
            flex: 1;
            transition: all 0.3s ease;
            margin-left: 0;
        }

        .main-content.sidebar-collapsed {
            margin-left: -280px;
        }

        /* Open Request Links */
        .open-request-link {
            color: var(--corporate-accent);
            cursor: pointer;
            text-decoration: underline;
            transition: all 0.2s ease;
        }

        .open-request-link:hover {
            color: var(--corporate-success);
            font-weight: 600;
        }

        .open-request-rectified {
            color: var(--corporate-success);
            font-weight: 600;
            text-decoration: line-through;
        }

        /* Corporate responsive design */
        @media (max-width: 768px) {
            .nav-sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100vh;
                z-index: 1000;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }

            .nav-sidebar.open {
                left: 0;
            }

            .sidebar-toggle-btn {
                display: none !important;
            }

            .section-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .maintenance-section {
                padding: 20px;
            }

            .main-content.sidebar-collapsed {
                margin-left: 0;
            }

            .excel-table {
                min-width: 1200px;
            }

            .excel-table .month-header {
                width: 80px;
                min-width: 80px;
                max-width: 80px;
            }
        }

        /* Corporate focus states */
        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid var(--corporate-accent);
            outline-offset: 2px;
        }

        /* Corporate loading states */
        .loading-spinner {
            border: 2px solid var(--corporate-border);
            border-top: 2px solid var(--corporate-accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Corporate header styling */
        .corporate-header {
            background: linear-gradient(135deg, var(--corporate-surface) 0%, var(--corporate-bg) 100%);
            border-bottom: 1px solid var(--corporate-border);
            padding: 32px 0;
            text-align: center;
        }

        .corporate-title {
            color: var(--corporate-primary);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 16px;
            letter-spacing: -0.025em;
        }

        .corporate-subtitle {
            color: var(--corporate-text-light);
            font-size: 1.125rem;
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Enhanced Summary Report Styling */
        .summary-stat {
            background: linear-gradient(135deg, var(--corporate-surface) 0%, var(--corporate-bg) 100%);
            border: 1px solid var(--corporate-border);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .summary-stat:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .summary-stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--corporate-primary);
        }

        .summary-stat-label {
            font-size: 0.875rem;
            color: var(--corporate-text-light);
            margin-top: 4px;
        }

        /* Year indicator styling */
        .year-indicator {
            font-size: 0.7em;
            opacity: 0.8;
            font-weight: 400;
            display: block;
            margin-top: 2px;
        }
    </style>
</head>
<body class="min-h-screen bg-corporate-surface transition-colors">

    <div class="flex min-h-screen">
        <!-- Corporate Navigation Sidebar -->
        <div id="navSidebar" class="nav-sidebar">
            <!-- Header -->
            <div class="p-6 border-b border-white border-opacity-20">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-md flex items-center justify-center">
                        <i class="fas fa-chart-line text-white text-lg"></i>
                    </div>
                    <div class="nav-text">
                        <h2 class="text-white font-semibold text-lg">Dashboard</h2>
                        <p class="text-white text-opacity-70 text-sm">Maintenance System</p>
                    </div>
                </div>
            </div>

            <!-- Navigation Items -->
            <div class="p-4 space-y-1">
                <div class="nav-item active" onclick="switchTab('preventive')">
                    <i class="fas fa-tools text-lg"></i>
                    <span class="nav-text">Preventive Maintenance</span>
                </div>
                <div class="nav-item" onclick="switchTab('service')">
                    <i class="fas fa-headset text-lg"></i>
                    <span class="nav-text">Service Request</span>
                </div>
                <div class="nav-item" onclick="switchTab('openitems')">
                    <i class="fas fa-exclamation-triangle text-lg"></i>
                    <span class="nav-text">Open Items Tracker</span>
                </div>
                <div class="nav-item" onclick="switchTab('biometrics')">
                    <i class="fas fa-id-card text-lg"></i>
                    <span class="nav-text">Biometrics Log</span>
                </div>
                <div class="nav-item" onclick="switchTab('summary')">
                    <i class="fas fa-table text-lg"></i>
                    <span class="nav-text">Summary View</span>
                </div>
                <div class="nav-item" onclick="switchTab('allreports')">
                    <i class="fas fa-chart-bar text-lg"></i>
                    <span class="nav-text">Analytics</span>
                </div>
                <div class="nav-item" onclick="switchTab('savedreports')">
                    <i class="fas fa-history text-lg"></i>
                    <span class="nav-text">Report Archive</span>
                </div>
                <div class="nav-item" onclick="toggleDarkMode()">
                    <i class="fas fa-moon text-lg" id="darkModeIcon"></i>
                    <span class="nav-text">Dark Mode</span>
                </div>
                <div class="nav-item hidden md:flex" onclick="toggleSidebarCollapse()">
                    <i class="fas fa-chevron-left text-lg" id="collapseIcon"></i>
                    <span class="nav-text">Collapse</span>
                </div>
            </div>

            <!-- Settings -->
            <div class="absolute bottom-4 left-4 right-4">
                <button onclick="toggleSidebar()" class="nav-item w-full justify-center md:hidden">
                    <i class="fas fa-times text-lg"></i>
                    <span class="nav-text text-sm">Close</span>
                </button>
            </div>
        </div>

        <!-- Sidebar Toggle Button -->
        <button onclick="toggleSidebarCollapse()" class="sidebar-toggle-btn hidden md:flex" id="sidebarToggleBtn" title="Toggle Navigation">
            <i class="fas fa-chevron-left text-sm" id="toggleIcon"></i>
        </button>

        <!-- Main Content -->
        <div class="main-content flex-1">
            <!-- Mobile Header -->
            <div class="md:hidden bg-white dark:bg-gray-800 p-4 shadow-sm border-b border-corporate-border flex items-center justify-between">
                <button onclick="toggleSidebar()" class="text-corporate-primary">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h1 class="text-xl font-semibold text-corporate-primary">Maintenance Dashboard</h1>
                <div></div>
            </div>

            <div class="p-6">
                <!-- Corporate Header -->
                <div class="corporate-header mb-8 hidden md:block">
                    <h1 class="corporate-title">
                        Maintenance Management System
                    </h1>
                    <p class="corporate-subtitle">
                        Comprehensive tracking and analytics for maintenance operations, service requests, and facility management
                    </p>
                </div>

                <!-- Corporate Controls -->
                <div class="flex flex-wrap gap-3 mb-8 justify-center">
                    <button onclick="clearEntryForm()" id="newEntryBtn" 
                        class="btn-primary flex items-center gap-2">
                        <i class="fas fa-file-plus text-sm"></i>
                        New Entry
                    </button>
                    <button onclick="showCategoryManager()" 
                        class="btn-info flex items-center gap-2">
                        <i class="fas fa-tags text-sm"></i>
                        Categories
                    </button>
                    <button onclick="showKeyCardManager()" id="keyCardManagerBtn" style="display: none;"
                        class="btn-info flex items-center gap-2">
                        <i class="fas fa-credit-card text-sm"></i>
                        Key Cards
                    </button>
                    <button onclick="saveReportToTracker()" 
                        class="btn-warning flex items-center gap-2">
                        <i class="fas fa-bookmark text-sm"></i>
                        Save Report
                    </button>
                    <button onclick="exportToDesktop()" 
                        class="btn-info flex items-center gap-2">
                        <i class="fas fa-download text-sm"></i>
                        Export
                    </button>
                    <button onclick="loadReportFromFile()" 
                        class="btn-info flex items-center gap-2">
                        <i class="fas fa-folder-open text-sm"></i>
                        Import
                    </button>
                    <button onclick="exportToExcel()" 
                        class="btn-success flex items-center gap-2">
                        <i class="fas fa-file-excel text-sm"></i>
                        Excel
                    </button>
                    <button onclick="clearAllData()" 
                        class="btn-danger flex items-center gap-2">
                        <i class="fas fa-trash-alt text-sm"></i>
                        Clear
                    </button>
                </div>

                <!-- Hidden File Inputs -->
                <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileLoad(event)">

                <!-- Data Entry Section -->
                <div id="dataEntrySection" class="fade-in">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-8 h-8 bg-corporate-primary rounded-md flex items-center justify-center">
                            <i class="fas fa-keyboard text-white text-sm"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-corporate-primary" id="entryTitle">Data Entry - Preventive Maintenance</h3>
                    </div>
                    
                    <!-- Corporate Grid Layout -->
                    <div class="section-grid" id="maintenanceSections">
                        <!-- Request Section -->
                        <div class="maintenance-section" id="requestSection">
                            <div class="section-header">
                                <div class="section-icon bg-corporate-accent">
                                    <i class="fas fa-clipboard-list"></i>
                                </div>
                                <div>
                                    <h4 class="text-lg font-semibold text-corporate-text">Request Acknowledgement</h4>
                                    <p class="text-sm text-corporate-secondary">Track requests and acknowledgement rates</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-corporate-text mb-2">
                                        Category
                                    </label>
                                    <select id="requestCategorySelect" class="form-input w-full p-3 text-base">
                                        <option value="">Select Category</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-corporate-text mb-2">
                                        Month & Year
                                    </label>
                                    <select id="requestMonthSelect" class="form-input w-full p-3 text-base">
                                        <option value="">Select Month & Year</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-corporate-text mb-2">
                                        Number of Requests
                                    </label>
                                    <input type="number" id="requestsInput" min="0" 
                                        class="form-input w-full p-3 text-base" 
                                        placeholder="Enter number of requests">
                                </div>
                                
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-corporate-text mb-2">
                                        Number Acknowledged
                                    </label>
                                    <input type="number" id="acknowledgedInput" min="0" 
                                        class="form-input w-full p-3 text-base" 
                                        placeholder="Enter number acknowledged">
                                </div>
                                
                                <div class="form-group md:col-span-2">
                                    <label class="block text-sm font-medium text-corporate-text mb-2">
                                        Remarks
                                    </label>
                                    <textarea id="requestRemarksInput" rows="3" 
                                        class="form-input w-full p-3 text-base resize-none" 
                                        placeholder="Enter any remarks or notes..."></textarea>
                                </div>
                            </div>

                            <div class="flex justify-end">
                                <button onclick="addEntry('request')" 
                                    class="btn-primary flex items-center gap-2">
                                    <i class="fas fa-save text-sm"></i>
                                    Add Entry
                                </button>
                            </div>
                        </div>

                        <!-- Rectification Section -->
                        <div class="maintenance-section" id="rectificationSection">
                            <div class="section-header">
                                <div class="section-icon bg-corporate-warning">
                                    <i class="fas fa-wrench"></i>
                                </div>
                                <div>
                                    <h4 class="text-lg font-semibold text-corporate-text">Rectification</h4>
                                    <p class="text-sm text-corporate-secondary">Track rectification items and completion</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-corporate-text mb-2">
                                        Category
                                    </label>
                                    <select id="rectificationCategorySelect" class="form-input w-full p-3 text-base">
                                        <option value="">Select Category</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-corporate-text mb-2">
                                        Month & Year
                                    </label>
                                    <select id="rectificationMonthSelect" class="form-input w-full p-3 text-base">
                                        <option value="">Select Month & Year</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-corporate-text mb-2">
                                        Number of Items
                                    </label>
                                    <input type="number" id="itemsInput" min="0" 
                                        class="form-input w-full p-3 text-base" 
                                        placeholder="Enter number of items">
                                </div>
                                
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-corporate-text mb-2">
                                        Number Rectified
                                    </label>
                                    <input type="number" id="rectifiedInput" min="0" 
                                        class="form-input w-full p-3 text-base" 
                                        placeholder="Enter number rectified">
                                </div>
                                
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-corporate-text mb-2">
                                        Open Requests
                                    </label>
                                    <input type="number" id="openRequestInput" min="0" 
                                        class="form-input w-full p-3 text-base" 
                                        placeholder="Enter open requests">
                                </div>
                                
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-corporate-text mb-2">
                                        Remarks
                                    </label>
                                    <textarea id="rectificationRemarksInput" rows="3" 
                                        class="form-input w-full p-3 text-base resize-none" 
                                        placeholder="Enter any remarks or notes..."></textarea>
                                </div>
                            </div>

                            <div class="flex justify-end">
                                <button onclick="addEntry('rectification')" 
                                    class="btn-warning flex items-center gap-2">
                                    <i class="fas fa-save text-sm"></i>
                                    Add Entry
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Open Items Tracker Section -->
                <div id="openitemsSection" class="hidden fade-in">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-corporate-danger rounded-md flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-white text-sm"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-corporate-primary">Open Items Tracker</h3>
                        </div>
                        <button onclick="showAddOpenItemModal()" 
                            class="btn-primary flex items-center gap-2">
                            <i class="fas fa-plus text-sm"></i>
                            Add Open Item
                        </button>
                    </div>
                    
                    <div class="maintenance-section">
                        <div class="section-header">
                            <div class="section-icon bg-corporate-danger">
                                <i class="fas fa-list-ul"></i>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold text-corporate-text">Open Items Management</h4>
                                <p class="text-sm text-corporate-secondary">Track and manage open items until completion</p>
                            </div>
                        </div>
                        
                        <div id="openItemsTable"></div>
                    </div>
                </div>

                <!-- Biometrics Section -->
                <div id="biometricsSection" class="hidden fade-in">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-corporate-primary rounded-md flex items-center justify-center">
                                <i class="fas fa-id-card text-white text-sm"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-corporate-primary">Biometrics Management</h3>
                        </div>
                        <button onclick="toggleBiometricsContent()" id="biometricsToggleBtn"
                            class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md font-medium transition-all duration-200 flex items-center gap-2">
                            <i class="fas fa-eye-slash text-sm" id="biometricsToggleIcon"></i>
                            <span id="biometricsToggleText">Hide</span>
                        </button>
                    </div>
                    
                    <!-- Biometrics Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-corporate-secondary">Total Key Cards</p>
                                    <p class="text-2xl font-semibold text-corporate-text" id="totalKeyCards">0</p>
                                </div>
                                <div class="w-10 h-10 bg-corporate-accent rounded-md flex items-center justify-center">
                                    <i class="fas fa-credit-card text-white text-lg"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-corporate-secondary">Cards Issued</p>
                                    <p class="text-2xl font-semibold text-corporate-warning" id="cardsIssued">0</p>
                                </div>
                                <div class="w-10 h-10 bg-corporate-warning rounded-md flex items-center justify-center">
                                    <i class="fas fa-hand-holding text-white text-lg"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-corporate-secondary">Cards Available</p>
                                    <p class="text-2xl font-semibold text-corporate-success" id="cardsAvailable">0</p>
                                </div>
                                <div class="w-10 h-10 bg-corporate-success rounded-md flex items-center justify-center">
                                    <i class="fas fa-check-circle text-white text-lg"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-corporate-secondary">Issue Rate</p>
                                    <p class="text-2xl font-semibold text-corporate-accent" id="issueRate">0%</p>
                                </div>
                                <div class="w-10 h-10 bg-corporate-accent rounded-md flex items-center justify-center">
                                    <i class="fas fa-chart-line text-white text-lg"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-corporate-secondary">Return Rate</p>
                                    <p class="text-2xl font-semibold text-corporate-primary" id="returnRate">0%</p>
                                </div>
                                <div class="w-10 h-10 bg-corporate-primary rounded-md flex items-center justify-center">
                                    <i class="fas fa-undo text-white text-lg"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Biometrics Form -->
                    <div id="biometricsContent" class="maintenance-section">
                        <div class="section-header">
                            <div class="section-icon bg-corporate-primary">
                                <i class="fas fa-id-card"></i>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold text-corporate-text">Key Card Management</h4>
                                <p class="text-sm text-corporate-secondary">Track key card issuance and returns</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <!-- Issue Information -->
                            <div class="space-y-4">
                                <h5 class="text-base font-semibold text-corporate-text mb-4">
                                    Issue Information
                                </h5>
                                
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-corporate-text mb-2">
                                        Date
                                    </label>
                                    <input type="date" id="biometricsDate" 
                                        class="form-input w-full p-3 text-base">
                                </div>
                                
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-corporate-text mb-2">
                                        Issued To
                                    </label>
                                    <input type="text" id="biometricsIssuedTo" 
                                        class="form-input w-full p-3 text-base" 
                                        placeholder="Enter person's name">
                                </div>
                                
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-corporate-text mb-2">
                                        Department / Position
                                    </label>
                                    <input type="text" id="biometricsDepartment" 
                                        class="form-input w-full p-3 text-base" 
                                        placeholder="Enter department or position">
                                </div>
                                
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-corporate-text mb-2">
                                        Key Card Number
                                    </label>
                                    <input type="text" id="biometricsKeyCardNo" 
                                        class="form-input w-full p-3 text-base" 
                                        placeholder="Enter key card number">
                                </div>
                            </div>
                            
                            <!-- Return Information -->
                            <div class="space-y-4">
                                <h5 class="text-base font-semibold text-corporate-text mb-4">
                                    Return Information (Optional)
                                </h5>
                                
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-corporate-text mb-2">
                                        Date Returned
                                    </label>
                                    <input type="date" id="biometricsDateReturned" 
                                        class="form-input w-full p-3 text-base">
                                </div>
                                
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-corporate-text mb-2">
                                        Returned To
                                    </label>
                                    <input type="text" id="biometricsReturnedTo" 
                                        class="form-input w-full p-3 text-base" 
                                        placeholder="Enter who received the return">
                                </div>
                                
                                <div class="form-group">
                                    <label class="block text-sm font-medium text-corporate-text mb-2">
                                        Remarks
                                    </label>
                                    <textarea id="biometricsRemarks" rows="4" 
                                        class="form-input w-full p-3 text-base resize-none" 
                                        placeholder="Enter any remarks or notes..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end gap-4">
                            <button onclick="clearBiometricsForm()" 
                                class="px-6 py-3 text-corporate-secondary hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md font-medium transition-all duration-200 flex items-center gap-2">
                                <i class="fas fa-eraser text-sm"></i>
                                Clear Form
                            </button>
                            <button onclick="addBiometricsEntry()" 
                                class="btn-success flex items-center gap-2">
                                <i class="fas fa-save text-sm"></i>
                                Add Entry
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Summary Section -->
                <div id="summarySection" class="hidden">
                    <div class="card p-8 mb-8 fade-in">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-corporate-success rounded-md flex items-center justify-center">
                                    <i class="fas fa-file-excel text-white text-sm"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-corporate-primary">Enhanced Summary Report (2025 Default)</h3>
                            </div>
                        </div>

                        <!-- Summary Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" id="summaryStats">
                            <!-- Stats will be populated here -->
                        </div>

                        <!-- Summary Controls -->
                        <div class="summary-controls">
                            <div class="flex items-center gap-3 mb-4">
                                <i class="fas fa-filter text-corporate-accent"></i>
                                <span class="font-semibold text-corporate-text">Report Options:</span>
                            </div>
                            <div class="flex flex-wrap gap-3">
                                <button onclick="generateSummaryByTab('all')" 
                                    class="btn-primary text-sm">
                                    All Data
                                </button>
                                <button onclick="generateSummaryByTab('preventive')" 
                                    class="btn-info text-sm">
                                    Preventive Only
                                </button>
                                <button onclick="generateSummaryByTab('service')" 
                                    class="btn-info text-sm">
                                    Service Only
                                </button>
                                <button onclick="exportSummaryToExcel()" 
                                    class="btn-success text-sm">
                                    Export Excel
                                </button>
                                <button onclick="printSummary()" 
                                    class="btn-warning text-sm">
                                    Print
                                </button>
                            </div>
                        </div>

                        <!-- Summary Table Container -->
                        <div class="table-container">
                            <div id="excelSummaryTable"></div>
                        </div>
                    </div>
                </div>

                <!-- Report Tracker Section -->
                <div id="savedReportsSection" class="hidden">
                    <div class="card p-8 mb-8 fade-in">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-8 h-8 bg-corporate-primary rounded-md flex items-center justify-center">
                                <i class="fas fa-history text-white text-sm"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-corporate-primary">Report Archive</h3>
                        </div>
                        <div id="savedReportsList" class="space-y-4">
                            <!-- Saved reports will be displayed here -->
                        </div>
                    </div>
                </div>

                <!-- Analytics Section -->
                <div id="reportSection" class="hidden">
                    <!-- Summary Table -->
                    <div class="card p-8 mb-8 fade-in">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-corporate-success rounded-md flex items-center justify-center">
                                    <i class="fas fa-table text-white text-sm"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-corporate-primary" id="reportTitle">Analytics Overview</h3>
                            </div>
                        </div>
                        <div class="table-container">
                            <div id="summaryTable"></div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8">
                        <div class="card p-8">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-8 h-8 bg-corporate-accent rounded-md flex items-center justify-center">
                                    <i class="fas fa-chart-line text-white text-sm"></i>
                                </div>
                                <h4 class="text-lg font-semibold text-corporate-text" id="monthlyChartTitle">Performance Trends</h4>
                            </div>
                            <div class="chart-container">
                                <canvas id="monthlyChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="card p-8">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-8 h-8 bg-corporate-primary rounded-md flex items-center justify-center">
                                    <i class="fas fa-chart-bar text-white text-sm"></i>
                                </div>
                                <h4 class="text-lg font-semibold text-corporate-text">Category Analysis</h4>
                            </div>
                            <div class="chart-container">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Current Data Display -->
                <div class="card p-8 fade-in" id="currentDataSection">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-8 h-8 bg-corporate-accent rounded-md flex items-center justify-center">
                            <i class="fas fa-database text-white text-sm"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-corporate-primary" id="currentDataTitle">Current Data</h3>
                    </div>
                    <div id="currentDataTable" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Performance optimization variables
        let lastDataHash = null;
        let cachedReportData = null;
        let isGeneratingReport = false;
        let reportGenerationTimeout = null;

        // Sidebar collapse functionality
        let sidebarHidden = false;

        // Auto-save variables
        let autoSaveInterval;
        let isAutoSaveEnabled = true;

        function toggleSidebarCollapse() {
            const sidebar = document.getElementById('navSidebar');
            const toggleBtn = document.getElementById('sidebarToggleBtn');
            const toggleIcon = document.getElementById('toggleIcon');
            const collapseIcon = document.getElementById('collapseIcon');
            const mainContent = document.querySelector('.main-content');
            
            sidebarHidden = !sidebarHidden;
            
            if (sidebarHidden) {
                sidebar.classList.add('hidden-desktop');
                mainContent.classList.add('sidebar-collapsed');
                if (toggleIcon) {
                    toggleIcon.className = 'fas fa-arrow-right text-sm';
                }
                if (collapseIcon) {
                    collapseIcon.className = 'fas fa-chevron-right text-lg';
                }
                if (toggleBtn) {
                    toggleBtn.style.left = '20px';
                    toggleBtn.title = 'Show Navigation';
                }
            } else {
                sidebar.classList.remove('hidden-desktop');
                mainContent.classList.remove('sidebar-collapsed');
                if (toggleIcon) {
                    toggleIcon.className = 'fas fa-chevron-left text-sm';
                }
                if (collapseIcon) {
                    collapseIcon.className = 'fas fa-chevron-left text-lg';
                }
                if (toggleBtn) {
                    toggleBtn.style.left = '300px';
                    toggleBtn.title = 'Hide Navigation';
                }
            }
        }

        // Data Structure
        const defaultCategories = {
            preventive: [
                'Building - Civil Works', 'Electrical', 'Mechanical', 'Plumbing',
                'Security', 'Pest Control', 'Cleaning', 'Landscaping / Horticulture',
                'Emergency Assistance', 'Others', 'Health and Safety', 'Fire Alarm'
            ],
            service: [
                'HSE Induction', 'Visitor Request (Delivery)', 'Service Request',
                'Gate Pass Form (Pull-out only)', 'Talk to Agent'
            ]
        };
        
        let activeCategories = {
            preventive: [...defaultCategories.preventive],
            service: [...defaultCategories.service]
        };

        let maintenanceData = {
            preventive: {
                request: {},
                rectification: {}
            },
            service: {
                request: {},
                rectification: {}
            }
        };

        let openItemsData = {};
        let openItemsCounter = 1;

        let biometricsData = {
            logs: {},
            keyCards: []
        };
        
        let savedReports = [];
        let currentTab = 'preventive';
        let isDarkMode = false;
        let currentSummaryView = 'all';
        
        // Chart resize variables
        let chartInstances = {};
        
        const months = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];

        const maintenanceTypes = {
            request: {
                title: '100% Acknowledgement',
                fields: [
                    { id: 'requests', label: 'No. of Requests', key: 'requests', icon: 'fas fa-clipboard-list' },
                    { id: 'acknowledged', label: 'No. of Acknowledged', key: 'acknowledged', icon: 'fas fa-check-circle' }
                ],
                tableHeaders: ['No. of Request', 'Total No. of Ack Req', '% Rate'],
                calculation: (data) => data.requests > 0 ? ((data.acknowledged / data.requests) * 100).toFixed(1) : 0
            },
            rectification: {
                title: 'Rectification',
                fields: [
                    { id: 'items', label: 'No. of Items', key: 'items', icon: 'fas fa-list' },
                    { id: 'rectified', label: 'No. of Rectified', key: 'rectified', icon: 'fas fa-check' },
                    { id: 'open', label: 'Open Request', key: 'open', icon: 'fas fa-clock' }
                ],
                tableHeaders: ['No. of Items', 'No. of Rectified', 'Open Request', '% Rate'],
                calculation: (data) => data.items > 0 ? ((data.rectified / data.items) * 100).toFixed(1) : 0
            }
        };

        // Auto-categorization keywords
        const categorizationKeywords = {
            preventive: [
                'maintenance', 'preventive', 'scheduled', 'routine', 'inspection', 'cleaning',
                'filter', 'oil change', 'lubrication', 'calibration', 'testing', 'check-up',
                'overhaul', 'service', 'replacement parts', 'tune-up', 'adjustment'
            ],
            service: [
                'request', 'complaint', 'issue', 'problem', 'help', 'support', 'assistance',
                'repair', 'fix', 'broken', 'malfunction', 'error', 'fault', 'trouble',
                'urgent', 'emergency', 'immediate', 'escalation', 'ticket'
            ]
        };

        // Enhanced Month-Year Generation Functions
        function generateMonthYearOptions() {
            const currentYear = new Date().getFullYear();
            const options = [];
            
            // Default: Show 2025 months by default, but include current year if different
            const startYear = Math.max(2025, currentYear);
            const endYear = Math.max(2025, currentYear + 1);
            
            for (let year = startYear; year <= endYear; year++) {
                months.forEach(month => {
                    options.push(`${month} ${year}`);
                });
            }
            
            return options;
        }

        // Get available years from existing data
        function getAvailableYears() {
            const years = new Set();
            
            // Check maintenance data
            Object.keys(maintenanceData).forEach(tab => {
                Object.keys(maintenanceData[tab]).forEach(type => {
                    Object.keys(maintenanceData[tab][type]).forEach(category => {
                        Object.keys(maintenanceData[tab][type][category]).forEach(monthYear => {
                            const year = monthYear.split(' ')[1];
                            if (year) years.add(parseInt(year));
                        });
                    });
                });
            });
            
            // Check open items data  
            Object.values(openItemsData).forEach(item => {
                const year = item.month ? item.month.split(' ')[1] : null;
                if (year) years.add(parseInt(year));
            });
            
            // Always include 2025 as minimum, expandable to 2030
            years.add(2025);
            
            return Array.from(years).sort();
        }

        // Generate expanded month-year options including data years
        function generateExpandedMonthYearOptions() {
            const availableYears = getAvailableYears();
            const maxYear = Math.min(Math.max(...availableYears, 2025), 2030);
            const options = [];
            
            // Start from 2025, include all years up to maxYear
            for (let year = 2025; year <= maxYear; year++) {
                months.forEach(month => {
                    options.push(`${month} ${year}`);
                });
            }
            
            return options;
        }

        // Enhanced Data Functions for Reporting
        function getEnhancedMaintenanceData() {
            // Create a copy of maintenance data enhanced with open items
            const enhanced = JSON.parse(JSON.stringify(maintenanceData));
            
            // Update counts from open items tracker
            const openItemsByMonth = {};
            Object.values(openItemsData).forEach(item => {
                if (!openItemsByMonth[item.month]) {
                    openItemsByMonth[item.month] = { 
                        preventive: { open: 0, rectified: 0 },
                        service: { open: 0, rectified: 0 }
                    };
                }
                
                const category = item.category || 'preventive';
                if (item.status === 'Open') {
                    openItemsByMonth[item.month][category].open++;
                } else {
                    openItemsByMonth[item.month][category].rectified++;
                }
            });
            
            // Apply open items to enhanced data rectification
            Object.keys(enhanced).forEach(tab => {
                if (enhanced[tab].rectification) {
                    Object.keys(openItemsByMonth).forEach(month => {
                        const monthOpenItems = openItemsByMonth[month][tab];
                        if (monthOpenItems && (monthOpenItems.open > 0 || monthOpenItems.rectified > 0)) {
                            // Find or create a category for open items
                            const openItemsCategory = 'Open Items (From Tracker)';
                            
                            if (!enhanced[tab].rectification[openItemsCategory]) {
                                enhanced[tab].rectification[openItemsCategory] = {};
                            }
                            
                            if (!enhanced[tab].rectification[openItemsCategory][month]) {
                                enhanced[tab].rectification[openItemsCategory][month] = {
                                    items: 0,
                                    rectified: 0,
                                    open: 0,
                                    remarks: 'Auto-generated from Open Items Tracker'
                                };
                            }
                            
                            const monthData = enhanced[tab].rectification[openItemsCategory][month];
                            monthData.items += monthOpenItems.open + monthOpenItems.rectified;
                            monthData.rectified += monthOpenItems.rectified;
                            monthData.open += monthOpenItems.open;
                        }
                    });
                }
            });
            
            return enhanced;
        }

        function getOpenItemsSummary() {
            const summary = {
                totalItems: 0,
                open: 0,
                rectified: 0,
                byMonth: {},
                byCategory: {}
            };
            
            Object.values(openItemsData).forEach(item => {
                summary.totalItems++;
                
                if (item.status === 'Open') {
                    summary.open++;
                } else {
                    summary.rectified++;
                }
                
                // By month
                if (!summary.byMonth[item.month]) {
                    summary.byMonth[item.month] = { open: 0, rectified: 0 };
                }
                if (item.status === 'Open') {
                    summary.byMonth[item.month].open++;
                } else {
                    summary.byMonth[item.month].rectified++;
                }
                
                // By category
                const category = item.category || 'preventive';
                if (!summary.byCategory[category]) {
                    summary.byCategory[category] = { open: 0, rectified: 0 };
                }
                if (item.status === 'Open') {
                    summary.byCategory[category].open++;
                } else {
                    summary.byCategory[category].rectified++;
                }
            });
            
            return summary;
        }

        function updateOpenRequestCounts() {
            // Update open request counts in rectification sections based on open items
            const openItems = Object.values(openItemsData).filter(item => item.status === 'Open');
            
            // Group by month and category
            const openByMonth = {};
            openItems.forEach(item => {
                if (!openByMonth[item.month]) {
                    openByMonth[item.month] = {};
                }
                const category = item.category || 'preventive';
                if (!openByMonth[item.month][category]) {
                    openByMonth[item.month][category] = 0;
                }
                openByMonth[item.month][category]++;
            });
            
            saveDataToLocalStorage();
        }

        function generateSummaryStats() {
            const statsContainer = document.getElementById('summaryStats');
            const openItemsSummary = getOpenItemsSummary();
            
            // Calculate totals from maintenance data
            let totalRequests = 0, totalAcknowledged = 0, totalItems = 0, totalRectified = 0;
            
            Object.keys(maintenanceData).forEach(tab => {
                Object.keys(maintenanceData[tab]).forEach(type => {
                    Object.keys(maintenanceData[tab][type]).forEach(category => {
                        Object.keys(maintenanceData[tab][type][category]).forEach(month => {
                            const data = maintenanceData[tab][type][category][month];
                            if (type === 'request') {
                                totalRequests += data.requests || 0;
                                totalAcknowledged += data.acknowledged || 0;
                            } else {
                                totalItems += data.items || 0;
                                totalRectified += data.rectified || 0;
                            }
                        });
                    });
                });
            });
            
            // Include open items in totals
            totalItems += openItemsSummary.totalItems;
            totalRectified += openItemsSummary.rectified;
            
            const acknowledgementRate = totalRequests > 0 ? ((totalAcknowledged / totalRequests) * 100).toFixed(1) : 0;
            const rectificationRate = totalItems > 0 ? ((totalRectified / totalItems) * 100).toFixed(1) : 0;
            
            statsContainer.innerHTML = `
                <div class="summary-stat">
                    <div class="summary-stat-value">${totalRequests}</div>
                    <div class="summary-stat-label">Total Requests</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value">${acknowledgementRate}%</div>
                    <div class="summary-stat-label">Acknowledgement Rate</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value">${totalItems}</div>
                    <div class="summary-stat-label">Total Items</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value">${rectificationRate}%</div>
                    <div class="summary-stat-label">Rectification Rate</div>
                </div>
            `;
        }

        // Helper Functions
        function hasData(data) {
            return Object.keys(data).some(type => 
                Object.keys(data[type]).length > 0 && 
                Object.keys(data[type]).some(category => 
                    Object.keys(data[type][category]).length > 0
                )
            );
        }

        function formatEntryDetails(type, entry) {
            let details = '';
            if (type === 'request') {
                details = `Requests: ${entry.requests || 0}, Acknowledged: ${entry.acknowledged || 0}`;
            } else if (type === 'rectification') {
                details = `Items: ${entry.items || 0}, Rectified: ${entry.rectified || 0}, Open: ${entry.open || 0}`;
            }
            
            if (entry.remarks) {
                details += ` | Remarks: ${entry.remarks}`;
            }
            
            return details;
        }

        function editEntry(type, category, month) {
            const entry = maintenanceData[currentTab][type][category][month];
            showAlert(`Edit functionality for ${type} - ${category} - ${month}`, 'info');
        }

        function deleteEntry(type, category, month) {
            showConfirmDialog(`Are you sure you want to delete the ${type} entry for ${category} in ${month}?`, function() {
                delete maintenanceData[currentTab][type][category][month];
                
                if (Object.keys(maintenanceData[currentTab][type][category]).length === 0) {
                    delete maintenanceData[currentTab][type][category];
                }
                
                saveDataToLocalStorage();
                updateCurrentDataTable();
                showAlert('Entry deleted successfully!', 'success');
            });
        }

        // Open Items Functions
        function showAddOpenItemModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
            
            const monthYearOptions = generateExpandedMonthYearOptions();
            
            modal.innerHTML = `
                <div class="modal-dialog p-8 max-w-lg w-full mx-4">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 bg-orange-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-plus text-white text-xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Add Open Item</h3>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="form-group">
                            <label class="block text-sm font-medium text-corporate-text mb-2">
                                Case ID <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="openItemCaseId" class="form-input w-full p-3 text-base" 
                                placeholder="Enter Case ID from FacilityBot (e.g., FB-2025-001)">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Enter the Case ID provided by FacilityBot system</p>
                        </div>
                        
                        <div class="form-group">
                            <label class="block text-sm font-medium text-corporate-text mb-2">
                                Month & Year <span class="text-red-500">*</span>
                            </label>
                            <select id="openItemMonth" class="form-input w-full p-3 text-base">
                                <option value="">Select Month & Year</option>
                                ${monthYearOptions.map(option => `<option value="${option}">${option}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="block text-sm font-medium text-corporate-text mb-2">
                                Category <span class="text-red-500">*</span>
                            </label>
                            <select id="openItemCategory" class="form-input w-full p-3 text-base">
                                <option value="">Select Category</option>
                                <option value="preventive">Preventive Maintenance</option>
                                <option value="service">Service Request</option>
                                <option value="auto">Auto-detect from Description</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="block text-sm font-medium text-corporate-text mb-2">
                                Priority Level
                            </label>
                            <select id="openItemPriority" class="form-input w-full p-3 text-base">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="block text-sm font-medium text-corporate-text mb-2">
                                Open Items Description <span class="text-red-500">*</span>
                            </label>
                            <textarea id="openItemDescription" rows="3" class="form-input w-full p-3 text-base resize-none" 
                                placeholder="Describe the open item..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="block text-sm font-medium text-corporate-text mb-2">Remarks</label>
                            <textarea id="openItemRemarks" rows="2" class="form-input w-full p-3 text-base resize-none" 
                                placeholder="Additional remarks..."></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-4 mt-6">
                        <button class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md font-semibold transition-all duration-300" onclick="this.closest('.fixed').remove()">
                            Cancel
                        </button>
                        <button onclick="addOpenItem()" class="btn-primary px-6 py-3 text-white rounded-md font-semibold transition-all duration-300">
                            <i class="fas fa-plus mr-2"></i>Add Item
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function addOpenItem() {
            const caseId = document.getElementById('openItemCaseId').value.trim();
            const month = document.getElementById('openItemMonth').value;
            const category = document.getElementById('openItemCategory').value;
            const priority = document.getElementById('openItemPriority').value;
            const description = document.getElementById('openItemDescription').value.trim();
            const remarks = document.getElementById('openItemRemarks').value.trim();
            
            if (!caseId || !month || !category || !description) {
                showAlert('Please fill in all required fields (marked with *)', 'warning');
                return;
            }
            
            // Auto-detect category if selected
            let finalCategory = category;
            if (category === 'auto') {
                finalCategory = autoDetectCategory(description, remarks);
                if (finalCategory === 'auto') {
                    showAlert('Could not auto-detect category. Please select manually.', 'warning');
                    return;
                }
            }
            
            // Check if Case ID already exists
            const existingItem = Object.values(openItemsData).find(item => item.caseId === caseId);
            if (existingItem) {
                showAlert(`Case ID "${caseId}" already exists!`, 'warning');
                return;
            }
            
            const itemId = Date.now().toString();
            openItemsData[itemId] = {
                id: itemId,
                caseId: caseId,
                month: month,
                category: finalCategory,
                priority: priority,
                description: description,
                remarks: remarks,
                dateCreated: new Date().toISOString().split('T')[0],
                status: 'Open',
                dateCompleted: null,
                completionRemarks: null
            };
            
            saveDataToLocalStorage();
            updateOpenItemsTable();
            updateOpenRequestCounts();
            
            const modal = document.querySelector('.fixed.inset-0.bg-black');
            if (modal) {
                document.body.removeChild(modal);
            }
            
            const categoryText = finalCategory === 'preventive' ? 'Preventive Maintenance' : 'Service Request';
            showAlert(`Open item ${caseId} added successfully! Categorized as: ${categoryText}`, 'success');
        }

        function updateOpenItemsTable() {
            const container = document.getElementById('openItemsTable');
            const items = Object.values(openItemsData);
            
            if (items.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">No open items yet. Click "Add Open Item" to get started.</p>';
                return;
            }
            
            let html = '<div class="overflow-x-auto"><table class="w-full text-sm border border-gray-200 dark:border-gray-700 rounded-lg">';
            html += '<thead class="bg-gray-50 dark:bg-gray-800">';
            html += '<tr>';
            html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Month & Year</th>';
            html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Case ID</th>';
            html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Category</th>';
            html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Priority</th>';
            html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Description</th>';
            html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Status</th>';
            html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Date Completed</th>';
            html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Actions</th>';
            html += '</tr></thead><tbody>';
            
            items.sort((a, b) => new Date(b.dateCreated) - new Date(a.dateCreated)).forEach(item => {
                const statusClass = item.status === 'Rectified' ? 'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100' : 'bg-orange-100 text-orange-800 dark:bg-orange-800 dark:text-orange-100';
                const priorityClass = `priority-${item.priority}`;
                const categoryText = item.category === 'preventive' ? 'Preventive' : 'Service';
                
                html += '<tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">';
                html += `<td class="px-4 py-3 text-gray-700 dark:text-gray-300">${item.month}</td>`;
                html += `<td class="px-4 py-3 font-mono text-gray-900 dark:text-white">${item.caseId}</td>`;
                html += `<td class="px-4 py-3 text-gray-700 dark:text-gray-300">${categoryText}</td>`;
                html += `<td class="px-4 py-3"><span class="status-badge ${priorityClass}">${item.priority}</span></td>`;
                html += `<td class="px-4 py-3 text-gray-700 dark:text-gray-300 max-w-md">${item.description}</td>`;
                html += `<td class="px-4 py-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${item.status}</span></td>`;
                html += `<td class="px-4 py-3 text-gray-700 dark:text-gray-300">${item.dateCompleted ? new Date(item.dateCompleted).toLocaleDateString() : '-'}</td>`;
                html += '<td class="px-4 py-3">';
                
                if (item.status === 'Open') {
                    html += `<button onclick="markAsRectified('${item.id}')" class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300 mr-3" title="Mark as Rectified">
                        <i class="fas fa-check-circle"></i>
                    </button>`;
                }
                
                html += `<button onclick="editOpenItem('${item.id}')" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 mr-3" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteOpenItem('${item.id}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>`;
                
                html += '</td></tr>';
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function markAsRectified(itemId) {
            showPromptDialog('Mark this item as rectified.\n\nEnter completion remarks:', function(remarks) {
                if (remarks !== null) {
                    openItemsData[itemId].status = 'Rectified';
                    openItemsData[itemId].dateCompleted = new Date().toISOString().split('T')[0];
                    openItemsData[itemId].completionRemarks = remarks.trim();
                    
                    // Auto-update rectification counts in maintenance data
                    updateRectificationCountsFromOpenItems();
                    
                    saveDataToLocalStorage();
                    updateOpenItemsTable();
                    updateOpenRequestCounts();
                    updateCurrentDataTable();
                    showAlert(`✅ Item ${openItemsData[itemId].caseId} marked as rectified! Rectification counts auto-updated.`, 'success');
                }
            });
        }

        function editOpenItem(itemId) {
            const item = openItemsData[itemId];
            if (!item) return;
            
            showAlert(`Edit functionality for ${item.caseId} - Feature coming soon!`, 'info');
        }

        function deleteOpenItem(itemId) {
            const item = openItemsData[itemId];
            if (!item) return;
            
            showConfirmDialog(`Are you sure you want to delete ${item.caseId}?`, function() {
                delete openItemsData[itemId];
                saveDataToLocalStorage();
                updateOpenItemsTable();
                updateOpenRequestCounts();
                showAlert(`Item ${item.caseId} deleted successfully!`, 'success');
            });
        }

        function showOpenRequestsModal(monthYear, category) {
            const openItemsForMonth = Object.values(openItemsData)
                .filter(item => item.month === monthYear && item.status === 'Open');
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
            
            let itemsHTML = '';
            if (openItemsForMonth.length > 0) {
                itemsHTML = '<div class="space-y-3">';
                openItemsForMonth.forEach(item => {
                    const priorityClass = `priority-${item.priority}`;
                    const categoryText = item.category === 'preventive' ? 'Preventive' : 'Service';
                    
                    itemsHTML += `
                        <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-4 bg-gray-50 dark:bg-gray-700">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    <span class="font-mono text-sm font-semibold text-blue-600 dark:text-blue-400">${item.caseId}</span>
                                    <span class="status-badge ${priorityClass}">${item.priority}</span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">${categoryText}</span>
                                </div>
                                <button onclick="markAsRectified('${item.id}'); this.closest('.fixed').remove();" 
                                    class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300 text-sm font-medium">
                                    Mark as Rectified
                                </button>
                            </div>
                            <p class="text-gray-700 dark:text-gray-300 mb-2">${item.description}</p>
                            ${item.remarks ? `<p class="text-sm text-gray-500 dark:text-gray-400">Remarks: ${item.remarks}</p>` : ''}
                        </div>
                    `;
                });
                itemsHTML += '</div>';
            } else {
                itemsHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">No open items found for this month.</p>';
            }
            
            modal.innerHTML = `
                <div class="modal-dialog p-8 max-w-2xl w-full mx-4">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 bg-orange-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Open Items for ${monthYear}</h3>
                            <p class="text-gray-600 dark:text-gray-400">Category: ${category}</p>
                        </div>
                    </div>
                    
                    <div class="max-h-96 overflow-y-auto">
                        ${itemsHTML}
                    </div>
                    
                    <div class="flex justify-end gap-4 mt-6">
                        <button class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md font-semibold transition-all duration-300" onclick="this.closest('.fixed').remove()">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Biometrics Functions
        function toggleBiometricsContent() {
            const content = document.getElementById('biometricsContent');
            const icon = document.getElementById('biometricsToggleIcon');
            const text = document.getElementById('biometricsToggleText');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.className = 'fas fa-eye-slash text-sm';
                text.textContent = 'Hide';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-eye text-sm';
                text.textContent = 'Show';
            }
        }

        function updateBiometricsStats() {
            const totalCards = biometricsData.keyCards.length;
            const logs = Object.values(biometricsData.logs);
            
            const issuedCards = logs.filter(log => !log.dateReturned).length;
            const availableCards = totalCards - issuedCards;
            const returnedCards = logs.filter(log => log.dateReturned).length;
            const returnRate = logs.length > 0 ? ((returnedCards / logs.length) * 100).toFixed(1) : 0;
            const issueRate = totalCards > 0 ? ((issuedCards / totalCards) * 100).toFixed(1) : 0;
            
            document.getElementById('totalKeyCards').textContent = totalCards;
            document.getElementById('cardsIssued').textContent = issuedCards;
            document.getElementById('cardsAvailable').textContent = availableCards;
            document.getElementById('issueRate').textContent = issueRate + '%';
            document.getElementById('returnRate').textContent = returnRate + '%';
        }

        function addBiometricsEntry() {
            const date = document.getElementById('biometricsDate').value;
            const issuedTo = document.getElementById('biometricsIssuedTo').value.trim();
            const department = document.getElementById('biometricsDepartment').value.trim();
            const keyCardNo = document.getElementById('biometricsKeyCardNo').value.trim();
            const dateReturned = document.getElementById('biometricsDateReturned').value;
            const returnedTo = document.getElementById('biometricsReturnedTo').value.trim();
            const remarks = document.getElementById('biometricsRemarks').value.trim();
            
            if (!date || !issuedTo || !department || !keyCardNo) {
                showAlert('Please fill in all required fields (Date, Issued To, Department, Key Card No.)', 'warning');
                return;
            }
            
            if (!biometricsData.keyCards.includes(keyCardNo)) {
                biometricsData.keyCards.push(keyCardNo);
                biometricsData.keyCards.sort((a, b) => {
                    const numA = parseInt(a) || 0;
                    const numB = parseInt(b) || 0;
                    if (numA && numB) {
                        return numA - numB;
                    }
                    return a.localeCompare(b);
                });
            }
            
            const entryId = Date.now().toString();
            biometricsData.logs[entryId] = {
                id: entryId,
                date: date,
                issuedTo: issuedTo,
                department: department,
                keyCardNo: keyCardNo,
                dateReturned: dateReturned || null,
                returnedTo: returnedTo || null,
                remarks: remarks
            };
            
            saveDataToLocalStorage();
            updateBiometricsStats();
            clearBiometricsForm();
            updateCurrentDataTable();
            
            showAlert('Biometrics entry added successfully!', 'success');
        }

        function clearBiometricsForm() {
            document.getElementById('biometricsDate').value = '';
            document.getElementById('biometricsIssuedTo').value = '';
            document.getElementById('biometricsDepartment').value = '';
            document.getElementById('biometricsKeyCardNo').value = '';
            document.getElementById('biometricsDateReturned').value = '';
            document.getElementById('biometricsReturnedTo').value = '';
            document.getElementById('biometricsRemarks').value = '';
        }

        function showKeyCardManager() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
            
            const issuedCards = Object.values(biometricsData.logs)
                .filter(log => !log.dateReturned)
                .map(log => log.keyCardNo);
            
            let cardListHTML = '';
            if (biometricsData.keyCards.length > 0) {
                cardListHTML = '<div class="mb-6"><h4 class="font-semibold text-gray-900 dark:text-white mb-3">Current Key Cards:</h4><div class="max-h-40 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-lg p-3 bg-gray-50 dark:bg-gray-700">';
                biometricsData.keyCards.forEach(card => {
                    const isIssued = issuedCards.includes(card);
                    const statusBadge = isIssued ? 
                        '<span class="status-badge status-issued ml-2">Issued</span>' : 
                        '<span class="status-badge status-returned ml-2">Available</span>';
                    
                    cardListHTML += `
                        <div class="flex items-center justify-between py-2 px-3 mb-2 bg-white dark:bg-gray-600 rounded border">
                            <div class="flex items-center">
                                <span class="font-mono text-gray-900 dark:text-white">#${card}</span>
                                ${statusBadge}
                            </div>
                            <button onclick="deleteKeyCard('${card}', ${isIssued})" 
                                class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 ${isIssued ? 'opacity-50 cursor-not-allowed' : ''}" 
                                ${isIssued ? 'disabled title="Cannot delete issued key card"' : 'title="Delete key card"'}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                });
                cardListHTML += '</div></div>';
            } else {
                cardListHTML = '<div class="mb-6 text-center text-gray-500 dark:text-gray-400 py-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">No key cards registered yet.</div>';
            }
            
            modal.innerHTML = `
                <div class="modal-dialog p-8 max-w-lg w-full mx-4">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-credit-card text-white text-xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Key Card Manager</h3>
                    </div>
                    
                    ${cardListHTML}
                    
                    <div class="border-t border-gray-200 dark:border-gray-600 pt-6">
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-3">Add New Key Cards:</h4>
                        <input type="text" id="newKeyCardsInput" class="form-input w-full p-4 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:outline-none mb-4" placeholder="Enter key card numbers (comma-separated)">
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Example: KC001, KC002, SECURITY-01</p>
                    </div>
                    
                    <div class="flex justify-end gap-4">
                        <button class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md font-semibold transition-all duration-300" onclick="this.closest('.fixed').remove()">
                            Cancel
                        </button>
                        <button onclick="addNewKeyCards()" class="btn-primary px-6 py-3 text-white rounded-md font-semibold transition-all duration-300">
                            <i class="fas fa-plus mr-2"></i>Add Cards
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                document.getElementById('newKeyCardsInput').focus();
            }, 100);
        }

        function addNewKeyCards() {
            const input = document.getElementById('newKeyCardsInput').value;
            const modal = document.querySelector('.fixed.inset-0.bg-black');
            
            if (input && input.trim()) {
                const newCards = input.split(',').map(card => card.trim()).filter(card => card);
                let addedCount = 0;
                
                newCards.forEach(card => {
                    if (!biometricsData.keyCards.includes(card)) {
                        biometricsData.keyCards.push(card);
                        addedCount++;
                    }
                });
                
                if (addedCount > 0) {
                    biometricsData.keyCards.sort((a, b) => {
                        const numA = parseInt(a) || 0;
                        const numB = parseInt(b) || 0;
                        if (numA && numB) {
                            return numA - numB;
                        }
                        return a.localeCompare(b);
                    });
                    
                    saveDataToLocalStorage();
                    updateBiometricsStats();
                    
                    if (modal) {
                        document.body.removeChild(modal);
                    }
                    
                    showAlert(`${addedCount} key card(s) added successfully!`, 'success');
                } else {
                    showAlert('No new key cards added (all already exist)', 'warning');
                }
            } else {
                if (modal) {
                    document.body.removeChild(modal);
                }
            }
        }

        function deleteKeyCard(cardNumber, isIssued) {
            if (isIssued) {
                showAlert('Cannot delete key card that is currently issued', 'warning');
                return;
            }
            
            showConfirmDialog(`Are you sure you want to delete key card #${cardNumber}?`, function() {
                const index = biometricsData.keyCards.indexOf(cardNumber);
                if (index > -1) {
                    biometricsData.keyCards.splice(index, 1);
                    saveDataToLocalStorage();
                    updateBiometricsStats();
                    
                    const modal = document.querySelector('.fixed.inset-0.bg-black');
                    if (modal) {
                        document.body.removeChild(modal);
                    }
                    
                    setTimeout(() => {
                        showKeyCardManager();
                    }, 100);
                    
                    showAlert(`Key card #${cardNumber} deleted successfully!`, 'success');
                }
            });
        }

        function editBiometricsEntry(entryId) {
            const entry = biometricsData.logs[entryId];
            if (!entry) return;
            
            document.getElementById('biometricsDate').value = entry.date;
            document.getElementById('biometricsIssuedTo').value = entry.issuedTo;
            document.getElementById('biometricsDepartment').value = entry.department;
            document.getElementById('biometricsKeyCardNo').value = entry.keyCardNo;
            document.getElementById('biometricsDateReturned').value = entry.dateReturned || '';
            document.getElementById('biometricsReturnedTo').value = entry.returnedTo || '';
            document.getElementById('biometricsRemarks').value = entry.remarks || '';
            
            delete biometricsData.logs[entryId];
            
            showAlert('Entry loaded for editing. Make changes and save again.', 'info');
        }

        function deleteBiometricsEntry(entryId) {
            showConfirmDialog('Are you sure you want to delete this biometrics entry?', function() {
                delete biometricsData.logs[entryId];
                saveDataToLocalStorage();
                updateBiometricsStats();
                updateCurrentDataTable();
                showAlert('Biometrics entry deleted successfully!', 'success');
            });
        }

        function returnKeyCard(entryId) {
            const entry = biometricsData.logs[entryId];
            
            if (!entry) {
                showAlert('Entry not found!', 'error');
                return;
            }
            
            if (entry.dateReturned) {
                showAlert(`Key card #${entry.keyCardNo} was already returned on ${new Date(entry.dateReturned).toLocaleDateString()} to ${entry.returnedTo || 'Unknown'}`, 'warning');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            showPromptDialog(`Return key card #${entry.keyCardNo} from ${entry.issuedTo}?\n\nEnter who received the return:`, function(returnedTo) {
                if (returnedTo && returnedTo.trim()) {
                    entry.dateReturned = today;
                    entry.returnedTo = returnedTo.trim();
                    
                    saveDataToLocalStorage();
                    updateBiometricsStats();
                    updateCurrentDataTable();
                    showAlert(`Key card #${entry.keyCardNo} marked as returned!`, 'success');
                }
            });
        }

        // Navigation Functions
        function toggleSidebar() {
            const sidebar = document.getElementById('navSidebar');
            sidebar.classList.toggle('open');
        }

        function switchTab(tabName) {
            currentTab = tabName;
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');
            
            document.getElementById('dataEntrySection').style.display = 'none';
            document.getElementById('currentDataSection').style.display = 'none';
            document.getElementById('openitemsSection').classList.add('hidden');
            document.getElementById('biometricsSection').classList.add('hidden');
            document.getElementById('summarySection').classList.add('hidden');
            document.getElementById('savedReportsSection').classList.add('hidden');
            document.getElementById('reportSection').classList.add('hidden');
            
            document.getElementById('keyCardManagerBtn').style.display = tabName === 'biometrics' ? 'flex' : 'none';
            
            if (tabName === 'openitems') {
                document.getElementById('openitemsSection').classList.remove('hidden');
                updateOpenItemsTable();
            } else if (tabName === 'biometrics') {
                document.getElementById('biometricsSection').classList.remove('hidden');
                document.getElementById('currentDataSection').style.display = 'block';
                document.getElementById('currentDataTitle').textContent = 'Biometrics - Current Data Entries';
                updateBiometricsStats();
                updateCurrentDataTable();
            } else if (tabName === 'summary') {
                document.getElementById('summarySection').classList.remove('hidden');
                generateSummaryStats();
                generateSummaryByTab('all');
            } else if (tabName === 'allreports') {
                generateAllReports();
            } else if (tabName === 'savedreports') {
                document.getElementById('savedReportsSection').classList.remove('hidden');
                displaySavedReports();
            } else {
                document.getElementById('dataEntrySection').style.display = 'block';
                document.getElementById('currentDataSection').style.display = 'block';
                
                const tabTitle = tabName === 'preventive' ? 'Preventive Maintenance' : 'Service Request';
                document.getElementById('entryTitle').textContent = `Data Entry - ${tabTitle}`;
                document.getElementById('currentDataTitle').textContent = `${tabTitle} - Current Data Entries`;
                
                updateCategoryDropdowns();
                updateCurrentDataTable();
            }
            
            if (window.innerWidth < 768) {
                toggleSidebar();
            }
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                document.getElementById('darkModeIcon').className = 'fas fa-sun text-lg';
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('darkModeIcon').className = 'fas fa-moon text-lg';
            }
            
            saveDataToLocalStorage();
            
            if (chartInstances.monthlyChart || chartInstances.categoryChart) {
                setTimeout(() => {
                    if (chartInstances.monthlyChart) {
                        generateMonthlyChart();
                    }
                    if (chartInstances.categoryChart) {
                        generateCategoryChart();
                    }
                }, 100);
            }
            
            showAlert(`Switched to ${isDarkMode ? 'dark' : 'light'} mode`, 'info');
        }

        function generateSummaryByTab(viewType) {
            currentSummaryView = viewType;
            const container = document.getElementById('excelSummaryTable');
            
            let dataToProcess = {};
            if (viewType === 'all') {
                dataToProcess = getEnhancedMaintenanceData();
            } else {
                const enhanced = getEnhancedMaintenanceData();
                dataToProcess[viewType] = enhanced[viewType];
            }
            
            const hasAnyData = Object.keys(dataToProcess).some(tab => hasData(dataToProcess[tab]));
            const hasOpenItems = Object.keys(openItemsData).length > 0;
            
            if (!hasAnyData && !hasOpenItems) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">No data available for the selected view.</p>';
                return;
            }
            
            generateExcelStyleTable(dataToProcess, container);
        }

        function generateExcelStyleTable(dataToProcess, container) {
            let html = '<table class="excel-table w-full">';
            
            html += '<thead><tr>';
            html += '<th class="type-header" style="width: 320px; min-width: 320px; max-width: 320px;">Category & Type</th>';
            
            const monthYearOptions = generateExpandedMonthYearOptions();
            
            // Create month headers with year included
            monthYearOptions.forEach(monthYear => {
                const [month, year] = monthYear.split(' ');
                const monthAbbr = month.substr(0, 3);
                html += `<th class="month-header" title="${month} ${year}">
                    ${monthAbbr}
                    <span class="year-indicator">${year}</span>
                </th>`;
            });
            
            html += '<th class="total-header">TOTAL</th>';
            html += '</tr></thead><tbody>';
            
            const categoriesUsed = new Set();
            Object.keys(dataToProcess).forEach(tab => {
                Object.keys(dataToProcess[tab]).forEach(type => {
                    Object.keys(dataToProcess[tab][type]).forEach(category => {
                        categoriesUsed.add(category);
                    });
                });
            });

            Array.from(categoriesUsed).forEach(category => {
                Object.keys(dataToProcess).forEach(tab => {
                    const tabData = dataToProcess[tab];
                    const tabHasDataForCategory = Object.keys(tabData).some(type => 
                        tabData[type][category] && Object.keys(tabData[type][category]).length > 0
                    );
                    
                    if (!tabHasDataForCategory) return;
                    
                    const tabTypes = ['request', 'rectification'];
                    const tabLabel = Object.keys(dataToProcess).length > 1 ? 
                        (tab === 'preventive' ? ' (Preventive)' : ' (Service)') : '';
                    
                    tabTypes.forEach(type => {
                        const typeData = tabData[type][category] || {};
                        
                        html += '<tr>';
                        
                        // Combined category and type
                        html += `<td class="type-header" style="text-align: left !important; padding-left: 12px !important;">
                            <div class="font-semibold">${category}${tabLabel}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${maintenanceTypes[type].title}</div>
                        </td>`;
                        
                        const totals = { requests: 0, acknowledged: 0, items: 0, rectified: 0, open: 0 };
                        Object.keys(typeData).forEach(monthYear => {
                            const monthData = typeData[monthYear];
                            Object.keys(monthData).forEach(key => {
                                if (key !== 'remarks' && typeof monthData[key] === 'number') {
                                    totals[key] += monthData[key];
                                }
                            });
                        });
                        
                        monthYearOptions.forEach(monthYear => {
                            const monthData = typeData[monthYear];
                            if (monthData) {
                                const percentage = parseFloat(maintenanceTypes[type].calculation(monthData));
                                const cellClass = getPerformanceClass(percentage);
                                
                                let detailsText = '';
                                if (type === 'request') {
                                    detailsText = `(${monthData.acknowledged || 0}/${monthData.requests || 0})`;
                                } else {
                                    detailsText = `(${monthData.rectified || 0}/${monthData.items || 0}`;
                                    if (monthData.open > 0) {
                                        detailsText += `, ${monthData.open} open`;
                                    }
                                    detailsText += ')';
                                }
                                
                                html += `<td class="${cellClass}" title="${detailsText}">
                                    <div style="font-weight: 700; margin-bottom: 2px;">${percentage}%</div>
                                    <div style="font-size: 0.7em; opacity: 0.8;">${detailsText}</div>
                                </td>`;
                            } else {
                                html += '<td class="text-gray-400">-</td>';
                            }
                        });
                        
                        const totalPercentage = parseFloat(maintenanceTypes[type].calculation(totals));
                        const totalClass = getPerformanceClass(totalPercentage);
                        
                        let totalDetailsText = '';
                        if (type === 'request') {
                            totalDetailsText = `(${totals.acknowledged}/${totals.requests})`;
                        } else {
                            totalDetailsText = `(${totals.rectified}/${totals.items}`;
                            if (totals.open > 0) {
                                totalDetailsText += `, ${totals.open} open`;
                            }
                            totalDetailsText += ')';
                        }
                        
                        html += `<td class="${totalClass} total-header">
                            <div style="font-weight: 800; margin-bottom: 2px;">${totalPercentage}%</div>
                            <div style="font-size: 0.7em; opacity: 0.9;">${totalDetailsText}</div>
                        </td>`;
                        
                        html += '</tr>';
                    });
                });
            });
            
            // Add Open Items Summary
            const openItemsSummary = getOpenItemsSummary();
            if (openItemsSummary.totalItems > 0) {
                html += '<tr style="background: #fef3c7 !important; border-top: 2px solid #f59e0b;">';
                html += '<td class="font-bold" style="background: #fef3c7 !important; color: #92400e !important; text-align: center; padding: 12px;">📋 Open Items Tracker Summary</td>';
                
                monthYearOptions.forEach(monthYear => {
                    const monthlyOpen = openItemsSummary.byMonth[monthYear] || { open: 0, rectified: 0 };
                    const monthlyTotal = monthlyOpen.open + monthlyOpen.rectified;
                    
                    if (monthlyTotal > 0) {
                        const completionRate = ((monthlyOpen.rectified / monthlyTotal) * 100).toFixed(1);
                        const cellClass = getPerformanceClass(completionRate);
                        const detailsText = `(${monthlyOpen.rectified}/${monthlyTotal}${monthlyOpen.open > 0 ? `, ${monthlyOpen.open} open` : ''})`;
                        
                        html += `<td class="${cellClass}" style="background: #fef3c7 !important;">
                            <div style="font-weight: 700; margin-bottom: 2px;">${completionRate}%</div>
                            <div style="font-size: 0.7em; opacity: 0.8;">${detailsText}</div>
                        </td>`;
                    } else {
                        html += '<td style="background: #fef3c7 !important; color: #92400e;">-</td>';
                    }
                });
                
                const overallCompletionRate = ((openItemsSummary.rectified / openItemsSummary.totalItems) * 100).toFixed(1);
                const overallClass = getPerformanceClass(overallCompletionRate);
                const overallDetailsText = `(${openItemsSummary.rectified}/${openItemsSummary.totalItems}${openItemsSummary.open > 0 ? `, ${openItemsSummary.open} open` : ''})`;
                
                html += `<td class="${overallClass}" style="background: var(--corporate-warning) !important; border-left: 2px solid var(--corporate-warning);">
                    <div style="font-weight: 800; margin-bottom: 2px;">${overallCompletionRate}%</div>
                    <div style="font-size: 0.7em; opacity: 0.9;">${overallDetailsText}</div>
                </td>`;
                html += '</tr>';
            }
            
            // Add Monthly Request Totals Row
            html += '<tr style="background: #e0f2fe !important; border-top: 2px solid #0277bd;">';
            html += '<td class="font-bold" style="background: #e0f2fe !important; color: #01579b !important; text-align: center; padding: 12px;">📊 Total Requests</td>';
            
            let grandTotalRequests = 0;
            monthYearOptions.forEach(monthYear => {
                let monthlyRequestTotal = 0;
                
                // Sum all requests for this month across all categories and tabs
                Object.keys(dataToProcess).forEach(tab => {
                    Object.keys(dataToProcess[tab].request || {}).forEach(category => {
                        const monthData = dataToProcess[tab].request[category][monthYear];
                        if (monthData && monthData.requests) {
                            monthlyRequestTotal += monthData.requests;
                        }
                    });
                });
                
                grandTotalRequests += monthlyRequestTotal;
                
                if (monthlyRequestTotal > 0) {
                    html += `<td style="background: #e0f2fe !important; color: #01579b !important; text-align: center; font-weight: 700;">
                        <div style="font-weight: 800;">${monthlyRequestTotal}</div>
                    </td>`;
                } else {
                    html += '<td style="background: #e0f2fe !important; color: #01579b;">-</td>';
                }
            });
            
            html += `<td style="background: #0277bd !important; color: white !important; text-align: center; font-weight: 800;">
                <div style="font-weight: 800;">${grandTotalRequests}</div>
            </td>`;
            html += '</tr>';
            
            html += '<tr class="total-row">';
            html += '<td class="font-bold text-center">OVERALL PERFORMANCE</td>';
            
            monthYearOptions.forEach(monthYear => {
                let monthlyTotal = 0;
                let monthlyCount = 0;
                
                Object.keys(dataToProcess).forEach(tab => {
                    Object.keys(dataToProcess[tab]).forEach(type => {
                        Object.keys(dataToProcess[tab][type]).forEach(category => {
                            const monthData = dataToProcess[tab][type][category][monthYear];
                            if (monthData) {
                                monthlyTotal += parseFloat(maintenanceTypes[type].calculation(monthData));
                                monthlyCount++;
                            }
                        });
                    });
                });
                
                // Include open items in monthly average
                const monthlyOpen = openItemsSummary.byMonth[monthYear] || { open: 0, rectified: 0 };
                const monthlyOpenTotal = monthlyOpen.open + monthlyOpen.rectified;
                if (monthlyOpenTotal > 0) {
                    const openItemsRate = (monthlyOpen.rectified / monthlyOpenTotal) * 100;
                    monthlyTotal += openItemsRate;
                    monthlyCount++;
                }
                
                const monthlyAverage = monthlyCount > 0 ? (monthlyTotal / monthlyCount).toFixed(1) : 0;
                html += `<td class="font-bold">
                    <div style="font-weight: 800; margin-bottom: 2px;">${monthlyAverage}%</div>
                    <div style="font-size: 0.7em; opacity: 0.9;">(${monthlyCount} items)</div>
                </td>`;
            });
            
            let overallTotal = 0;
            let overallCount = 0;
            
            Object.keys(dataToProcess).forEach(tab => {
                Object.keys(dataToProcess[tab]).forEach(type => {
                    Object.keys(dataToProcess[tab][type]).forEach(category => {
                        Object.keys(dataToProcess[tab][type][category]).forEach(monthYear => {
                            const monthData = dataToProcess[tab][type][category][monthYear];
                            overallTotal += parseFloat(maintenanceTypes[type].calculation(monthData));
                            overallCount++;
                        });
                    });
                });
            });
            
            // Include open items in overall average
            if (openItemsSummary.totalItems > 0) {
                const overallOpenItemsRate = (openItemsSummary.rectified / openItemsSummary.totalItems) * 100;
                overallTotal += overallOpenItemsRate;
                overallCount++;
            }
            
            const overallAverage = overallCount > 0 ? (overallTotal / overallCount).toFixed(1) : 0;
            html += `<td class="font-bold total-header">
                <div style="font-weight: 800; margin-bottom: 2px;">${overallAverage}%</div>
                <div style="font-size: 0.7em; opacity: 0.9;">(${overallCount} total)</div>
            </td>`;
            html += '</tr>';
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function getPerformanceClass(percentage) {
            if (percentage >= 80) return 'performance-excellent';
            if (percentage >= 60) return 'performance-good';
            return 'performance-poor';
        }

        function updateCurrentDataTable() {
            const container = document.getElementById('currentDataTable');
            
            if (currentTab === 'biometrics') {
                const logs = Object.values(biometricsData.logs);
                
                if (logs.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">No biometrics entries yet. Use the form above to add data.</p>';
                    return;
                }
                
                let html = '<div class="overflow-x-auto"><table class="w-full text-sm border border-gray-200 dark:border-gray-700 rounded-lg">';
                html += '<thead class="bg-gray-50 dark:bg-gray-800">';
                html += '<tr>';
                html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Date</th>';
                html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Issued To</th>';
                html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Department</th>';
                html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Key Card No.</th>';
                html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Status</th>';
                html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Date Returned</th>';
                html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Actions</th>';
                html += '</tr></thead><tbody>';
                
                logs.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(log => {
                    const isReturned = log.dateReturned;
                    const statusClass = isReturned ? 'status-returned' : 'status-issued';
                    const statusText = isReturned ? 'Returned' : 'Issued';
                    
                    html += '<tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">';
                    html += `<td class="px-4 py-3 text-gray-700 dark:text-gray-300">${new Date(log.date).toLocaleDateString()}</td>`;
                    html += `<td class="px-4 py-3 text-gray-700 dark:text-gray-300">${log.issuedTo}</td>`;
                    html += `<td class="px-4 py-3 text-gray-700 dark:text-gray-300">${log.department}</td>`;
                    html += `<td class="px-4 py-3 font-mono text-gray-900 dark:text-white">#${log.keyCardNo}</td>`;
                    html += `<td class="px-4 py-3"><span class="status-badge ${statusClass}">${statusText}</span></td>`;
                    html += `<td class="px-4 py-3 text-gray-700 dark:text-gray-300">${isReturned ? new Date(log.dateReturned).toLocaleDateString() : '-'}</td>`;
                    html += `<td class="px-4 py-3">
                        <button onclick="editBiometricsEntry('${log.id}')" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 mr-3" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>`;
                    
                    if (!isReturned) {
                        html += `<button onclick="returnKeyCard('${log.id}')" class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300 mr-3" title="Return Key Card">
                            <i class="fas fa-undo"></i>
                        </button>`;
                    }
                    
                    html += `<button onclick="deleteBiometricsEntry('${log.id}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
                return;
            }
            
            const data = maintenanceData[currentTab];
            
            if (!hasData(data)) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">No data entries yet. Use the form above to add data.</p>';
                return;
            }
            
            let html = '<div class="overflow-x-auto"><table class="w-full text-sm border border-gray-200 dark:border-gray-700 rounded-lg">';
            html += '<thead class="bg-gray-50 dark:bg-gray-800">';
            html += '<tr>';
            html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Type</th>';
            html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Category</th>';
            html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Month & Year</th>';
            html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Details</th>';
            html += '<th class="px-4 py-3 text-left font-semibold text-gray-900 dark:text-white border-b">Actions</th>';
            html += '</tr></thead><tbody>';
            
            Object.keys(data).forEach(type => {
                Object.keys(data[type]).forEach(category => {
                    Object.keys(data[type][category]).forEach(monthYear => {
                        const entry = data[type][category][monthYear];
                        html += '<tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">';
                        html += `<td class="px-4 py-3 font-medium text-gray-900 dark:text-white capitalize">${type}</td>`;
                        html += `<td class="px-4 py-3 text-gray-700 dark:text-gray-300">${category}</td>`;
                        html += `<td class="px-4 py-3 text-gray-700 dark:text-gray-300">${monthYear}</td>`;
                        
                        // Enhanced details with clickable open requests
                        let details = formatEntryDetails(type, entry);
                        if (type === 'rectification' && entry.open > 0) {
                            const openItemsForMonth = Object.values(openItemsData)
                                .filter(item => item.month === monthYear && item.status === 'Open');
                            
                            if (openItemsForMonth.length > 0) {
                                details = details.replace(`Open: ${entry.open}`, 
                                    `Open: <span class="open-request-link" onclick="showOpenRequestsModal('${monthYear}', '${category}')">${entry.open} (View Items)</span>`);
                            }
                        }
                        
                        html += `<td class="px-4 py-3 text-gray-700 dark:text-gray-300 max-w-md">${details}</td>`;
                        html += `<td class="px-4 py-3">
                            <button onclick="editEntry('${type}', '${category}', '${monthYear}')" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 mr-3">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteEntry('${type}', '${category}', '${monthYear}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>`;
                        html += '</tr>';
                    });
                });
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function addEntry(type) {
            let category, monthYear, data = {};
            
            if (type === 'request') {
                category = document.getElementById('requestCategorySelect').value;
                monthYear = document.getElementById('requestMonthSelect').value;
                data.requests = parseInt(document.getElementById('requestsInput').value) || 0;
                data.acknowledged = parseInt(document.getElementById('acknowledgedInput').value) || 0;
                data.remarks = document.getElementById('requestRemarksInput').value.trim();
            } else if (type === 'rectification') {
                category = document.getElementById('rectificationCategorySelect').value;
                monthYear = document.getElementById('rectificationMonthSelect').value;
                data.items = parseInt(document.getElementById('itemsInput').value) || 0;
                data.rectified = parseInt(document.getElementById('rectifiedInput').value) || 0;
                data.open = parseInt(document.getElementById('openRequestInput').value) || 0;
                data.remarks = document.getElementById('rectificationRemarksInput').value.trim();
            }
            
            if (!category || !monthYear) {
                showAlert('Please select both category and month & year', 'warning');
                return;
            }
            
            if (!maintenanceData[currentTab][type][category]) {
                maintenanceData[currentTab][type][category] = {};
            }
            
            maintenanceData[currentTab][type][category][monthYear] = data;
            
            // Auto-sync with open items tracker for requests
            if (type === 'request' && data.requests > 0) {
                showAutoSyncRequestsModal(currentTab, category, monthYear, data.requests, data.acknowledged);
            }
            
            saveDataToLocalStorage();
            
            showAlert(`${type} entry added successfully for ${monthYear}!`, 'success');
            
            if (type === 'request') {
                document.getElementById('requestsInput').value = '';
                document.getElementById('acknowledgedInput').value = '';
                document.getElementById('requestRemarksInput').value = '';
            } else if (type === 'rectification') {
                document.getElementById('itemsInput').value = '';
                document.getElementById('rectifiedInput').value = '';
                document.getElementById('openRequestInput').value = '';
                document.getElementById('rectificationRemarksInput').value = '';
            }
            
            updateCurrentDataTable();
            updateOpenItemsSync();
        }

        function updateCategoryDropdowns() {
            const categorySelects = ['requestCategorySelect', 'rectificationCategorySelect'];
            
            categorySelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select Category</option>';
                    
                    const categories = activeCategories[currentTab] || [];
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        if (category === currentValue) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                }
            });
            
            // Update month-year dropdowns with expanded options
            const monthSelects = ['requestMonthSelect', 'rectificationMonthSelect'];
            const monthYearOptions = generateExpandedMonthYearOptions();
            
            monthSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select Month & Year</option>';
                    
                    monthYearOptions.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option;
                        optionElement.textContent = option;
                        if (option === currentValue) {
                            optionElement.selected = true;
                        }
                        select.appendChild(optionElement);
                    });
                }
            });
        }

        function showCategoryManager() {
            if (currentTab === 'biometrics') {
                showKeyCardManager();
                return;
            }
            
            const categories = activeCategories[currentTab] || [];
            const categoryList = categories.map(cat => `• ${cat}`).join('\n');
            
            let infoText = `Current categories for ${currentTab}:\n\n${categoryList}`;
            
            showPromptDialog(`${infoText}\n\nAdd new category:`, function(newCategory) {
                if (newCategory && newCategory.trim()) {
                    const trimmedCategory = newCategory.trim();
                    if (!activeCategories[currentTab].includes(trimmedCategory)) {
                        activeCategories[currentTab].push(trimmedCategory);
                        saveDataToLocalStorage();
                        updateCategoryDropdowns();
                        showAlert(`Category "${trimmedCategory}" added successfully!`, 'success');
                    } else {
                        showAlert('Category already exists!', 'warning');
                    }
                }
            });
        }

        function clearEntryForm() {
            if (currentTab === 'biometrics') {
                clearBiometricsForm();
                return;
            }
            
            const inputs = ['requestsInput', 'acknowledgedInput', 'itemsInput', 'rectifiedInput', 'openRequestInput'];
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) input.value = '';
            });
            
            const textareas = ['requestRemarksInput', 'rectificationRemarksInput'];
            textareas.forEach(textareaId => {
                const textarea = document.getElementById(textareaId);
                if (textarea) textarea.value = '';
            });
            
            const selects = ['requestCategorySelect', 'requestMonthSelect', 'rectificationCategorySelect', 'rectificationMonthSelect'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) select.value = '';
            });
            
            showAlert('Form cleared!', 'info');
        }

        function generateAllReports() {
            if (isGeneratingReport) {
                showAlert('Report generation in progress...', 'info');
                return;
            }

            const preventiveHasData = hasData(maintenanceData.preventive);
            const serviceHasData = hasData(maintenanceData.service);
            const hasOpenItems = Object.keys(openItemsData).length > 0;
            
            if (!preventiveHasData && !serviceHasData && !hasOpenItems) {
                showAlert('No data available for reports. Please add some data first.', 'warning');
                return;
            }

            isGeneratingReport = true;
            
            document.getElementById('reportSection').classList.remove('hidden');
            document.getElementById('dataEntrySection').style.display = 'none';
            document.getElementById('currentDataSection').style.display = 'none';
            document.getElementById('openitemsSection').classList.add('hidden');
            document.getElementById('biometricsSection').classList.add('hidden');
            document.getElementById('summarySection').classList.add('hidden');
            document.getElementById('savedReportsSection').classList.add('hidden');
            
            document.getElementById('reportTitle').textContent = 'Enhanced Analytics Overview (Including Open Items)';
            document.getElementById('monthlyChartTitle').textContent = 'Performance Trends (Including Open Items)';
            
            try {
                generateSummaryTable();
                generateCharts();
                showAlert('Enhanced analytics generated successfully!', 'success');
            } catch (error) {
                console.error('Error generating reports:', error);
                showAlert('Error generating reports. Please try again.', 'error');
            }
            
            isGeneratingReport = false;
        }

        function generateSummaryTable() {
            const container = document.getElementById('summaryTable');
            
            const combinedData = getEnhancedMaintenanceData();
            
            const hasPreventiveData = hasData(combinedData.preventive);
            const hasServiceData = hasData(combinedData.service);
            const hasOpenItems = Object.keys(openItemsData).length > 0;
            
            if (!hasPreventiveData && !hasServiceData && !hasOpenItems) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">No data available for summary table.</p>';
                return;
            }
            
            let html = '<table class="w-full text-sm border-collapse">';
            html += '<thead class="bg-gray-100 dark:bg-gray-800">';
            html += '<tr>';
            html += '<th class="px-6 py-4 text-left font-semibold text-gray-900 dark:text-white">Category/Tab</th>';
            html += '<th class="px-4 py-4 text-center font-semibold text-gray-900 dark:text-white border-l border-gray-300 dark:border-gray-600">Type</th>';
            
            const monthYearOptions = generateExpandedMonthYearOptions();
            monthYearOptions.forEach(monthYear => {
                const [month, year] = monthYear.split(' ');
                html += `<th class="px-4 py-4 text-center font-semibold text-gray-900 dark:text-white border-l border-gray-300 dark:border-gray-600">
                    ${month}
                    <br><span class="text-xs opacity-75">${year}</span>
                </th>`;
            });
            
            html += '<th class="px-4 py-4 text-center font-semibold text-gray-900 dark:text-white border-l border-gray-300 dark:border-gray-600 bg-gray-200 dark:bg-gray-700">TOTAL</th>';
            html += '</tr></thead><tbody>';
            
            const categoriesUsed = new Set();
            Object.keys(combinedData).forEach(tab => {
                Object.keys(combinedData[tab]).forEach(type => {
                    Object.keys(combinedData[tab][type]).forEach(category => {
                        categoriesUsed.add(category);
                    });
                });
            });

            let categoryIndex = 0;
            Array.from(categoriesUsed).forEach(category => {
                Object.keys(combinedData).forEach(tab => {
                    const tabData = combinedData[tab];
                    const tabHasDataForCategory = Object.keys(tabData).some(type => 
                        tabData[type][category] && Object.keys(tabData[type][category]).length > 0
                    );
                    
                    if (!tabHasDataForCategory) return;
                    
                    const tabTypes = ['request', 'rectification'];
                    
                    tabTypes.forEach((type, typeIndex) => {
                        const typeData = tabData[type][category] || {};
                        const rowBg = categoryIndex % 2 === 0 ? 'bg-gray-50 dark:bg-gray-800' : 'bg-white dark:bg-gray-900';
                        
                        html += `<tr class="${rowBg} hover:bg-blue-50 dark:hover:bg-blue-900 transition-colors">`;
                        
                        if (typeIndex === 0) {
                            const tabLabel = tab === 'preventive' ? 'Preventive' : 'Service';
                            html += `<td rowspan="2" class="px-6 py-4 font-semibold text-gray-900 dark:text-white border-r-2 border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-800">
                                <div class="flex flex-col gap-1">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-tag text-blue-500"></i>
                                        <span>${category}</span>
                                    </div>
                                    <div class="text-xs text-blue-600 dark:text-blue-400 font-normal">${tabLabel}</div>
                                </div>
                            </td>`;
                        }
                        
                        html += `<td class="px-4 py-3 text-center border-l border-gray-200 dark:border-gray-700">
                            <div class="text-gray-700 dark:text-gray-300 text-xs font-medium">${maintenanceTypes[type].title}</div>
                        </td>`;

                        const categoryTotals = { requests: 0, acknowledged: 0, items: 0, rectified: 0, open: 0 };
                        Object.keys(typeData).forEach(monthYear => {
                            const monthData = typeData[monthYear];
                            Object.keys(monthData).forEach(key => {
                                if (key !== 'remarks' && typeof monthData[key] === 'number') {
                                    categoryTotals[key] += monthData[key];
                                }
                            });
                        });
                        
                        monthYearOptions.forEach(monthYear => {
                            const monthData = typeData[monthYear];
                            if (monthData) {
                                const percentage = parseFloat(maintenanceTypes[type].calculation(monthData));
                                const percentageColor = percentage >= 80 ? 'text-green-600 dark:text-green-400' : 
                                                       percentage >= 60 ? 'text-yellow-600 dark:text-yellow-400' : 
                                                       'text-red-600 dark:text-red-400';
                                
                                let detailsText = '';
                                if (type === 'request') {
                                    detailsText = `${monthData.acknowledged || 0}/${monthData.requests || 0}`;
                                } else {
                                    detailsText = `${monthData.rectified || 0}/${monthData.items || 0}`;
                                    if (monthData.open > 0) {
                                        detailsText += ` (${monthData.open} open)`;
                                    }
                                }
                                
                                html += `<td class="px-4 py-3 text-center border-l border-gray-200 dark:border-gray-700">
                                    <div class="font-bold ${percentageColor} mb-1">${percentage}%</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">${detailsText}</div>
                                </td>`;
                            } else {
                                html += '<td class="px-4 py-3 text-center border-l border-gray-200 dark:border-gray-700 text-gray-400">-</td>';
                            }
                        });

                        const categoryPercentage = parseFloat(maintenanceTypes[type].calculation(categoryTotals));
                        const categoryPercentageColor = categoryPercentage >= 80 ? 'text-green-600 dark:text-green-400' : 
                                                       categoryPercentage >= 60 ? 'text-yellow-600 dark:text-yellow-400' : 
                                                       'text-red-600 dark:text-red-400';
                        
                        let totalDetailsText = '';
                        if (type === 'request') {
                            totalDetailsText = `${categoryTotals.acknowledged}/${categoryTotals.requests}`;
                        } else {
                            totalDetailsText = `${categoryTotals.rectified}/${categoryTotals.items}`;
                            if (categoryTotals.open > 0) {
                                totalDetailsText += ` (${categoryTotals.open} open)`;
                            }
                        }
                        
                        html += `<td class="px-4 py-3 text-center border-l border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-700">
                            <div class="font-bold ${categoryPercentageColor} mb-1">${categoryPercentage}%</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${totalDetailsText}</div>
                        </td>`;
                        
                        html += '</tr>';
                    });
                });
                categoryIndex++;
            });
            
            // Add Open Items Summary Row
            const openItemsSummary = getOpenItemsSummary();
            if (openItemsSummary.totalItems > 0) {
                html += '<tr class="bg-orange-50 dark:bg-orange-900 border-t-2 border-orange-200 dark:border-orange-700">';
                html += `<td colspan="2" class="px-6 py-4 font-bold text-orange-800 dark:text-orange-200">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>📋 Open Items Tracker Summary</span>
                    </div>
                </td>`;
                
                monthYearOptions.forEach(monthYear => {
                    const monthlyOpen = openItemsSummary.byMonth[monthYear] || { open: 0, rectified: 0 };
                    const monthlyTotal = monthlyOpen.open + monthlyOpen.rectified;
                    
                    if (monthlyTotal > 0) {
                        const completionRate = ((monthlyOpen.rectified / monthlyTotal) * 100).toFixed(1);
                        const rateColor = completionRate >= 80 ? 'text-green-600 dark:text-green-400' : 
                                         completionRate >= 60 ? 'text-yellow-600 dark:text-yellow-400' : 
                                         'text-red-600 dark:text-red-400';
                        
                        html += `<td class="px-4 py-3 text-center border-l border-orange-200 dark:border-orange-700">
                            <div class="font-bold ${rateColor} mb-1">${completionRate}%</div>
                            <div class="text-xs text-orange-600 dark:text-orange-300">${monthlyOpen.rectified}/${monthlyTotal}</div>
                            ${monthlyOpen.open > 0 ? `<div class="text-xs text-red-600 dark:text-red-400">${monthlyOpen.open} open</div>` : ''}
                        </td>`;
                    } else {
                        html += '<td class="px-4 py-3 text-center border-l border-orange-200 dark:border-orange-700 text-gray-400">-</td>';
                    }
                });
                
                const overallCompletionRate = ((openItemsSummary.rectified / openItemsSummary.totalItems) * 100).toFixed(1);
                const overallRateColor = overallCompletionRate >= 80 ? 'text-green-600 dark:text-green-400' : 
                                        overallCompletionRate >= 60 ? 'text-yellow-600 dark:text-yellow-400' : 
                                        'text-red-600 dark:text-red-400';
                
                html += `<td class="px-4 py-3 text-center border-l border-orange-200 dark:border-orange-700 bg-orange-100 dark:bg-orange-800">
                    <div class="font-bold ${overallRateColor} mb-1">${overallCompletionRate}%</div>
                    <div class="text-xs text-orange-600 dark:text-orange-300">${openItemsSummary.rectified}/${openItemsSummary.totalItems}</div>
                    ${openItemsSummary.open > 0 ? `<div class="text-xs text-red-600 dark:text-red-400">${openItemsSummary.open} open</div>` : ''}
                </td>`;
                
                html += '</tr>';
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function generateCharts() {
            generateMonthlyChart();
            generateCategoryChart();
        }

        function generateMonthlyChart() {
            const canvas = document.getElementById('monthlyChart');
            const ctx = canvas.getContext('2d');
            
            if (chartInstances.monthlyChart) {
                chartInstances.monthlyChart.destroy();
            }
            
            const monthlyData = calculateMonthlyPerformance();
            
            const datasets = [
                {
                    label: 'Preventive Maintenance',
                    data: monthlyData.preventive,
                    borderColor: '#10b981',
                    backgroundColor: '#10b98120',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4
                },
                {
                    label: 'Service Request',
                    data: monthlyData.service,
                    borderColor: '#3b82f6',
                    backgroundColor: '#3b82f620',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4
                },
                {
                    label: 'Open Items Tracker',
                    data: monthlyData.openItems,
                    borderColor: '#f59e0b',
                    backgroundColor: '#f59e0b20',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4
                },
                {
                    label: 'Overall Average',
                    data: monthlyData.overall,
                    borderColor: '#8b5cf6',
                    backgroundColor: '#8b5cf620',
                    borderWidth: 4,
                    fill: false,
                    tension: 0.4,
                    borderDash: [5, 5]
                }
            ];
            
            const monthYearLabels = generateExpandedMonthYearOptions();
            
            chartInstances.monthlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthYearLabels.map(monthYear => {
                        const [month, year] = monthYear.split(' ');
                        return `${month.substr(0, 3)} ${year}`;
                    }),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Month & Year'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Performance Rate (%)'
                            },
                            min: 0,
                            max: 100
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function generateCategoryChart() {
            const canvas = document.getElementById('categoryChart');
            const ctx = canvas.getContext('2d');
            
            if (chartInstances.categoryChart) {
                chartInstances.categoryChart.destroy();
            }
            
            const categoryData = calculateCategoryPerformance();
            
            if (categoryData.categories.length === 0) {
                chartInstances.categoryChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['No Data Available'],
                        datasets: [{
                            label: 'Average Performance (%)',
                            data: [0],
                            backgroundColor: ['#e5e7eb'],
                            borderColor: ['#d1d5db'],
                            borderWidth: 2,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Category'
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Performance Rate (%)'
                                },
                                min: 0,
                                max: 100
                            }
                        }
                    }
                });
                return;
            }
            
            const colors = categoryData.categories.map((_, index) => {
                const colorOptions = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#f97316', '#84cc16', '#ec4899', '#6366f1'];
                return colorOptions[index % colorOptions.length];
            });
            
            chartInstances.categoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categoryData.categories,
                    datasets: [{
                        label: 'Average Performance (%)',
                        data: categoryData.averages,
                        backgroundColor: colors.map(color => color + '80'),
                        borderColor: colors,
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Category'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Performance Rate (%)'
                            },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }

        function saveReportToTracker() {
            const preventiveHasData = hasData(maintenanceData.preventive);
            const serviceHasData = hasData(maintenanceData.service);
            const hasOpenItems = Object.keys(openItemsData).length > 0;
            const hasBiometrics = Object.keys(biometricsData.logs).length > 0;
            
            if (!preventiveHasData && !serviceHasData && !hasOpenItems && !hasBiometrics) {
                showAlert('No data available to save. Please add some data first.', 'warning');
                return;
            }
            
            showSaveReportModal();
        }

        function showSaveReportModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
            
            // Generate report summary
            const summary = generateReportSummary();
            
            modal.innerHTML = `
                <div class="modal-dialog p-8 max-w-lg w-full mx-4">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-bookmark text-white text-xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Save Report Snapshot</h3>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900 rounded-lg p-4 mb-6">
                        <p class="text-blue-800 dark:text-blue-200 mb-3">
                            <strong>Current Data Summary:</strong>
                        </p>
                        <ul class="text-blue-700 dark:text-blue-300 space-y-1 text-sm">
                            <li>• Preventive Maintenance: ${summary.preventiveEntries} entries</li>
                            <li>• Service Requests: ${summary.serviceEntries} entries</li>
                            <li>• Open Items: ${summary.openItems} items (${summary.openItemsOpen} open, ${summary.openItemsRectified} rectified)</li>
                            <li>• Biometrics: ${summary.biometricsEntries} entries</li>
                            <li>• Overall Performance: ${summary.overallPerformance}%</li>
                        </ul>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="form-group">
                            <label class="block text-sm font-medium text-corporate-text mb-2">
                                Report Name <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="reportName" class="form-input w-full p-3 text-base" 
                                placeholder="e.g., Q1 2025 Performance Report" 
                                value="Report - ${new Date().toLocaleDateString()}">
                        </div>
                        
                        <div class="form-group">
                            <label class="block text-sm font-medium text-corporate-text mb-2">
                                Description (Optional)
                            </label>
                            <textarea id="reportDescription" rows="3" class="form-input w-full p-3 text-base resize-none" 
                                placeholder="Brief description of this report snapshot..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="block text-sm font-medium text-corporate-text mb-2">
                                Report Type
                            </label>
                            <select id="reportType" class="form-input w-full p-3 text-base">
                                <option value="monthly">Monthly Report</option>
                                <option value="quarterly">Quarterly Report</option>
                                <option value="yearly">Yearly Report</option>
                                <option value="custom">Custom Report</option>
                                <option value="backup">Data Backup</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-4 mt-6">
                        <button class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md font-semibold transition-all duration-300" onclick="this.closest('.fixed').remove()">
                            Cancel
                        </button>
                        <button onclick="saveCurrentReport()" class="btn-success px-6 py-3 text-white rounded-md font-semibold transition-all duration-300">
                            <i class="fas fa-save mr-2"></i>Save Report
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                document.getElementById('reportName').focus();
            }, 100);
        }

        function generateReportSummary() {
            let preventiveEntries = 0, serviceEntries = 0;
            let totalPerformance = 0, performanceCount = 0;
            
            // Count maintenance entries and calculate performance
            Object.keys(maintenanceData).forEach(tab => {
                Object.keys(maintenanceData[tab]).forEach(type => {
                    Object.keys(maintenanceData[tab][type]).forEach(category => {
                        const categoryEntries = Object.keys(maintenanceData[tab][type][category]).length;
                        
                        if (tab === 'preventive') {
                            preventiveEntries += categoryEntries;
                        } else {
                            serviceEntries += categoryEntries;
                        }
                        
                        // Calculate performance for each entry
                        Object.keys(maintenanceData[tab][type][category]).forEach(month => {
                            const data = maintenanceData[tab][type][category][month];
                            const performance = parseFloat(maintenanceTypes[type].calculation(data));
                            totalPerformance += performance;
                            performanceCount++;
                        });
                    });
                });
            });
            
            // Count open items
            const openItemsSummary = getOpenItemsSummary();
            
            // Count biometrics entries
            const biometricsEntries = Object.keys(biometricsData.logs).length;
            
            // Calculate overall performance
            const overallPerformance = performanceCount > 0 ? (totalPerformance / performanceCount).toFixed(1) : 0;
            
            return {
                preventiveEntries,
                serviceEntries,
                openItems: openItemsSummary.totalItems,
                openItemsOpen: openItemsSummary.open,
                openItemsRectified: openItemsSummary.rectified,
                biometricsEntries,
                overallPerformance
            };
        }

        function saveCurrentReport() {
            const reportName = document.getElementById('reportName').value.trim();
            const reportDescription = document.getElementById('reportDescription').value.trim();
            const reportType = document.getElementById('reportType').value;
            
            if (!reportName) {
                showAlert('Please enter a report name', 'warning');
                return;
            }
            
            // Check if report name already exists
            const existingReport = savedReports.find(report => report.name === reportName);
            if (existingReport) {
                showAlert('A report with this name already exists. Please choose a different name.', 'warning');
                return;
            }
            
            // Create report snapshot
            const reportSnapshot = {
                id: Date.now().toString(),
                name: reportName,
                description: reportDescription,
                type: reportType,
                savedDate: new Date().toISOString(),
                summary: generateReportSummary(),
                data: {
                    maintenanceData: JSON.parse(JSON.stringify(maintenanceData)),
                    openItemsData: JSON.parse(JSON.stringify(openItemsData)),
                    biometricsData: JSON.parse(JSON.stringify(biometricsData)),
                    activeCategories: JSON.parse(JSON.stringify(activeCategories))
                }
            };
            
            savedReports.push(reportSnapshot);
            saveDataToLocalStorage();
            
            const modal = document.querySelector('.fixed.inset-0.bg-black');
            if (modal) {
                document.body.removeChild(modal);
            }
            
            showAlert(`✅ Report "${reportName}" saved successfully to Report Archive!`, 'success');
        }

        function exportToDesktop() {
            const data = {
                maintenanceData: maintenanceData,
                openItemsData: openItemsData,
                openItemsCounter: openItemsCounter,
                biometricsData: biometricsData,
                savedReports: savedReports,
                activeCategories: activeCategories,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `maintenance_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showAlert('Data exported successfully!', 'success');
        }

        function loadReportFromFile() {
            document.getElementById('fileInput').click();
        }

        function exportToExcel() {
            showAlert('Excel export feature coming soon!', 'info');
        }

        function exportSummaryToExcel() {
            const preventiveHasData = hasData(maintenanceData.preventive);
            const serviceHasData = hasData(maintenanceData.service);
            const hasOpenItems = Object.keys(openItemsData).length > 0;
            
            if (!preventiveHasData && !serviceHasData && !hasOpenItems) {
                showAlert('No data available to export', 'warning');
                return;
            }
            
            showAlert('Enhanced Excel export feature coming soon!', 'info');
        }

        function printSummary() {
            const printContent = document.getElementById('excelSummaryTable').innerHTML;
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Enhanced Maintenance Summary Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .excel-table { border-collapse: collapse; width: 100%; }
                            .excel-table th, .excel-table td { border: 1px solid #000; padding: 8px; text-align: center; }
                            .excel-table th { background-color: #334155; color: white; font-weight: bold; }
                            .category-header { background-color: #f3f4f6 !important; color: #000 !important; text-align: left !important; font-weight: bold; }
                            .total-row { background-color: #334155 !important; color: white !important; font-weight: bold; }
                            .performance-excellent { background-color: #dcfce7; color: #166534; }
                            .performance-good { background-color: #fef3c7; color: #92400e; }
                            .performance-poor { background-color: #fecaca; color: #991b1b; }
                            h1 { text-align: center; color: #334155; margin-bottom: 30px; }
                            .print-date { text-align: center; margin-bottom: 20px; color: #666; }
                            .year-indicator { font-size: 0.7em; opacity: 0.8; display: block; }
                        </style>
                    </head>
                    <body>
                        <h1>Enhanced Maintenance Summary Report (2025)</h1>
                        <div class="print-date">Generated on: ${new Date().toLocaleDateString()} (Including Open Items)</div>
                        ${printContent}
                    </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function clearAllData() {
            showConfirmDialog('Are you sure you want to clear all data? This action cannot be undone.', function() {
                maintenanceData = {
                    preventive: {
                        request: {},
                        rectification: {}
                    },
                    service: {
                        request: {},
                        rectification: {}
                    }
                };
                openItemsData = {};
                openItemsCounter = 1;
                biometricsData = {
                    logs: {},
                    keyCards: []
                };
                savedReports = [];
                
                saveDataToLocalStorage();
                updateCurrentDataTable();
                updateOpenItemsTable();
                updateBiometricsStats();
                showAlert('All data cleared successfully!', 'success');
            });
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.maintenanceData) {
                        maintenanceData = data.maintenanceData;
                    }
                    if (data.openItemsData) {
                        openItemsData = data.openItemsData;
                    }
                    if (data.openItemsCounter) {
                        openItemsCounter = data.openItemsCounter;
                    }
                    if (data.biometricsData) {
                        biometricsData = data.biometricsData;
                    }
                    if (data.savedReports) {
                        savedReports = data.savedReports;
                    }
                    if (data.activeCategories) {
                        activeCategories = data.activeCategories;
                    }
                    
                    saveDataToLocalStorage();
                    updateCategoryDropdowns();
                    updateCurrentDataTable();
                    updateOpenItemsTable();
                    updateBiometricsStats();
                    showAlert('Data loaded successfully!', 'success');
                } catch (error) {
                    showAlert('Error loading file: Invalid format', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function displaySavedReports() {
            const container = document.getElementById('savedReportsList');
            
            if (savedReports.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-16 h-16 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-folder-open text-gray-500 dark:text-gray-400 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">No Saved Reports</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-4">Save report snapshots to view them here later</p>
                        <button onclick="saveReportToTracker()" class="btn-primary">
                            <i class="fas fa-bookmark mr-2"></i>Save Your First Report
                        </button>
                    </div>
                `;
                return;
            }
            
            // Sort reports by saved date (newest first)
            const sortedReports = [...savedReports].sort((a, b) => new Date(b.savedDate) - new Date(a.savedDate));
            
            let html = '<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">';
            
            sortedReports.forEach(report => {
                const savedDate = new Date(report.savedDate);
                const typeColor = getReportTypeColor(report.type);
                const typeIcon = getReportTypeIcon(report.type);
                
                html += `
                    <div class="card hover:shadow-lg transition-all duration-300 p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 ${typeColor} rounded-lg flex items-center justify-center">
                                    <i class="${typeIcon} text-white"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900 dark:text-white line-clamp-1">${report.name}</h4>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">${report.type.charAt(0).toUpperCase() + report.type.slice(1)} Report</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="viewSavedReport('${report.id}')" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300" title="View Report">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="exportSavedReport('${report.id}')" class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300" title="Export Report">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button onclick="deleteSavedReport('${report.id}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" title="Delete Report">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        ${report.description ? `<p class="text-sm text-gray-600 dark:text-gray-400 mb-4 line-clamp-2">${report.description}</p>` : ''}
                        
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500 dark:text-gray-400">Performance:</span>
                                <span class="font-semibold text-corporate-primary">${report.summary.overallPerformance}%</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500 dark:text-gray-400">Total Items:</span>
                                <span class="font-semibold">${(report.summary.preventiveEntries + report.summary.serviceEntries + report.summary.openItems) || 0}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-500 dark:text-gray-400">Open Items:</span>
                                <span class="font-semibold ${report.summary.openItemsOpen > 0 ? 'text-orange-600' : 'text-green-600'}">${report.summary.openItemsOpen || 0}</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
                            <span class="text-xs text-gray-500 dark:text-gray-400">
                                Saved ${savedDate.toLocaleDateString()}
                            </span>
                            <span class="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full">
                                ${savedDate.toLocaleTimeString()}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function getReportTypeColor(type) {
            const colors = {
                monthly: 'bg-blue-500',
                quarterly: 'bg-green-500',
                yearly: 'bg-purple-500',
                custom: 'bg-orange-500',
                backup: 'bg-gray-500'
            };
            return colors[type] || 'bg-blue-500';
        }

        function getReportTypeIcon(type) {
            const icons = {
                monthly: 'fas fa-calendar-alt',
                quarterly: 'fas fa-chart-line',
                yearly: 'fas fa-calendar',
                custom: 'fas fa-cog',
                backup: 'fas fa-database'
            };
            return icons[type] || 'fas fa-file';
        }

        function viewSavedReport(reportId) {
            const report = savedReports.find(r => r.id === reportId);
            if (!report) {
                showAlert('Report not found!', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
            
            modal.innerHTML = `
                <div class="modal-dialog p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 ${getReportTypeColor(report.type)} rounded-lg flex items-center justify-center">
                                <i class="${getReportTypeIcon(report.type)} text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">${report.name}</h3>
                                <p class="text-gray-600 dark:text-gray-400">Saved on ${new Date(report.savedDate).toLocaleString()}</p>
                            </div>
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    ${report.description ? `
                        <div class="bg-blue-50 dark:bg-blue-900 rounded-lg p-4 mb-6">
                            <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Description:</h4>
                            <p class="text-blue-700 dark:text-blue-300">${report.description}</p>
                        </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="text-center p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <div class="text-2xl font-bold text-corporate-primary">${report.summary.preventiveEntries}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Preventive Entries</div>
                        </div>
                        <div class="text-center p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <div class="text-2xl font-bold text-corporate-accent">${report.summary.serviceEntries}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Service Entries</div>
                        </div>
                        <div class="text-center p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <div class="text-2xl font-bold text-corporate-warning">${report.summary.openItems}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Open Items</div>
                        </div>
                        <div class="text-center p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <div class="text-2xl font-bold text-corporate-success">${report.summary.overallPerformance}%</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Performance</div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-4">
                        <button onclick="loadSavedReportData('${reportId}')" class="btn-warning">
                            <i class="fas fa-upload mr-2"></i>Load This Data
                        </button>
                        <button onclick="exportSavedReport('${reportId}')" class="btn-success">
                            <i class="fas fa-download mr-2"></i>Export Report
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="btn-primary">
                            <i class="fas fa-times mr-2"></i>Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function loadSavedReportData(reportId) {
            const report = savedReports.find(r => r.id === reportId);
            if (!report) {
                showAlert('Report not found!', 'error');
                return;
            }
            
            showConfirmDialog(`Load data from "${report.name}"? This will replace your current data.`, function() {
                // Load the report data
                maintenanceData = report.data.maintenanceData || maintenanceData;
                openItemsData = report.data.openItemsData || {};
                biometricsData = report.data.biometricsData || { logs: {}, keyCards: [] };
                activeCategories = report.data.activeCategories || activeCategories;
                
                saveDataToLocalStorage();
                updateCategoryDropdowns();
                updateCurrentDataTable();
                updateOpenItemsTable();
                updateBiometricsStats();
                
                // Close modal
                const modal = document.querySelector('.fixed.inset-0.bg-black');
                if (modal) {
                    document.body.removeChild(modal);
                }
                
                showAlert(`✅ Data from "${report.name}" loaded successfully!`, 'success');
            });
        }

        function exportSavedReport(reportId) {
            const report = savedReports.find(r => r.id === reportId);
            if (!report) {
                showAlert('Report not found!', 'error');
                return;
            }
            
            const dataStr = JSON.stringify(report, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${report.name.replace(/[^a-z0-9]/gi, '_')}_${new Date(report.savedDate).toISOString().split('T')[0]}.json`;
            link.click();
            
            showAlert(`Report "${report.name}" exported successfully!`, 'success');
        }

        function deleteSavedReport(reportId) {
            const report = savedReports.find(r => r.id === reportId);
            if (!report) {
                showAlert('Report not found!', 'error');
                return;
            }
            
            showConfirmDialog(`Are you sure you want to delete "${report.name}"? This action cannot be undone.`, function() {
                const index = savedReports.findIndex(r => r.id === reportId);
                if (index > -1) {
                    savedReports.splice(index, 1);
                    saveDataToLocalStorage();
                    displaySavedReports();
                    showAlert(`Report "${report.name}" deleted successfully!`, 'success');
                }
            });
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            let bgColor, icon;
            
            switch(type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    icon = 'fas fa-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    icon = 'fas fa-exclamation-triangle';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-500';
                    icon = 'fas fa-exclamation-circle';
                    break;
                default:
                    bgColor = 'bg-blue-500';
                    icon = 'fas fa-info-circle';
            }
            
            alertDiv.className = `fixed top-6 right-6 ${bgColor} text-white px-6 py-4 rounded-md shadow-lg z-50 transform transition-all duration-300 translate-x-full max-w-md`;
            alertDiv.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="${icon} text-xl"></i>
                    <span class="font-medium">${message}</span>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                alertDiv.classList.add('translate-x-full');
                setTimeout(() => {
                    if (document.body.contains(alertDiv)) {
                        document.body.removeChild(alertDiv);
                    }
                }, 300);
            }, 4000);
        }

        function showConfirmDialog(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-dialog p-8 max-w-md w-full mx-4';
            modalContent.innerHTML = `
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">Confirm Action</h3>
                </div>
                <p class="text-gray-700 dark:text-gray-300 mb-8">${message}</p>
                <div class="flex justify-end gap-4">
                    <button id="cancelBtn" class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md font-semibold transition-all duration-300">
                        Cancel
                    </button>
                    <button id="confirmBtn" class="btn-danger px-6 py-3 text-white rounded-md font-semibold transition-all duration-300">
                        Confirm
                    </button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            modalContent.querySelector('#cancelBtn').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            modalContent.querySelector('#confirmBtn').addEventListener('click', function() {
                document.body.removeChild(modal);
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        function showPromptDialog(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-dialog p-8 max-w-md w-full mx-4';
            modalContent.innerHTML = `
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-edit text-white text-xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">Input Required</h3>
                </div>
                <p class="text-gray-700 dark:text-gray-300 mb-4 whitespace-pre-line">${message}</p>
                <input type="text" id="promptInput" class="form-input w-full p-4 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base focus:outline-none mb-6" placeholder="Enter text here...">
                <div class="flex justify-end gap-4">
                    <button id="cancelPromptBtn" class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md font-semibold transition-all duration-300">
                        Cancel
                    </button>
                    <button id="confirmPromptBtn" class="btn-primary px-6 py-3 text-white rounded-md font-semibold transition-all duration-300">
                        Confirm
                    </button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            const cancelBtn = modalContent.querySelector('#cancelPromptBtn');
            const confirmBtn = modalContent.querySelector('#confirmPromptBtn');
            const input = modalContent.querySelector('#promptInput');
            
            cancelBtn.addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            confirmBtn.addEventListener('click', function() {
                const value = input.value;
                document.body.removeChild(modal);
                if (typeof onConfirm === 'function') {
                    onConfirm(value);
                }
            });
            
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmBtn.click();
                }
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            setTimeout(() => {
                input.focus();
            }, 100);
        }

        function calculateMonthlyPerformance() {
            const monthlyData = {
                preventive: [],
                service: [],
                openItems: [],
                overall: []
            };
            
            const monthYearOptions = generateExpandedMonthYearOptions();
            const openItemsSummary = getOpenItemsSummary();
            
            monthYearOptions.forEach(monthYear => {
                const tabAverages = {};
                
                Object.keys(maintenanceData).forEach(tab => {
                    const tabData = maintenanceData[tab];
                    let monthlyTotal = 0;
                    let monthlyCount = 0;
                    
                    Object.keys(tabData).forEach(type => {
                        Object.keys(tabData[type]).forEach(category => {
                            const monthData = tabData[type][category][monthYear];
                            if (monthData) {
                                const percentage = parseFloat(maintenanceTypes[type].calculation(monthData));
                                monthlyTotal += percentage;
                                monthlyCount++;
                            }
                        });
                    });
                    
                    tabAverages[tab] = monthlyCount > 0 ? (monthlyTotal / monthlyCount) : 0;
                });
                
                monthlyData.preventive.push(tabAverages.preventive || 0);
                monthlyData.service.push(tabAverages.service || 0);
                
                // Add open items performance for this month
                const monthlyOpen = openItemsSummary.byMonth[monthYear] || { open: 0, rectified: 0 };
                const monthlyOpenTotal = monthlyOpen.open + monthlyOpen.rectified;
                const openItemsRate = monthlyOpenTotal > 0 ? 
                    (monthlyOpen.rectified / monthlyOpenTotal) * 100 : 0;
                monthlyData.openItems.push(openItemsRate);
                
                // Calculate overall average including open items
                const allValues = [tabAverages.preventive || 0, tabAverages.service || 0];
                if (openItemsRate > 0) {
                    allValues.push(openItemsRate);
                }
                const validValues = allValues.filter(val => val > 0);
                const overallAverage = validValues.length > 0 ? 
                    validValues.reduce((sum, val) => sum + val, 0) / validValues.length : 0;
                monthlyData.overall.push(overallAverage);
            });
            
            return monthlyData;
        }
        
        function calculateCategoryPerformance() {
            const categoryAverages = {};
            const openItemsSummary = getOpenItemsSummary();
            
            // Include regular maintenance data
            Object.keys(maintenanceData).forEach(tab => {
                const tabData = maintenanceData[tab];
                Object.keys(tabData).forEach(type => {
                    Object.keys(tabData[type]).forEach(category => {
                        if (!categoryAverages[category]) {
                            categoryAverages[category] = { total: 0, count: 0 };
                        }
                        
                        Object.keys(tabData[type][category]).forEach(monthYear => {
                            const monthData = tabData[type][category][monthYear];
                            const percentage = parseFloat(maintenanceTypes[type].calculation(monthData));
                            categoryAverages[category].total += percentage;
                            categoryAverages[category].count++;
                        });
                    });
                });
            });
            
            // Include open items summary
            if (openItemsSummary.totalItems > 0) {
                const openItemsCategory = 'Open Items Tracker';
                categoryAverages[openItemsCategory] = {
                    total: (openItemsSummary.rectified / openItemsSummary.totalItems) * 100,
                    count: 1
                };
            }
            
            const categories = [];
            const averages = [];
            
            Object.keys(categoryAverages).forEach(category => {
                const data = categoryAverages[category];
                const average = data.count > 0 ? (data.total / data.count) : 0;
                categories.push(category);
                averages.push(average);
            });
            
            return { categories, averages };
        }

        // Auto-categorization function
        function autoDetectCategory(description, remarks = '') {
            const text = (description + ' ' + remarks).toLowerCase();
            
            let preventiveScore = 0;
            let serviceScore = 0;
            
            // Count keyword matches
            categorizationKeywords.preventive.forEach(keyword => {
                if (text.includes(keyword)) {
                    preventiveScore++;
                }
            });
            
            categorizationKeywords.service.forEach(keyword => {
                if (text.includes(keyword)) {
                    serviceScore++;
                }
            });
            
            // Return category with higher score, or 'auto' if tied
            if (preventiveScore > serviceScore) {
                return 'preventive';
            } else if (serviceScore > preventiveScore) {
                return 'service';
            } else {
                return 'auto'; // Could not determine
            }
        }

        // Data persistence functions
        function saveDataToLocalStorage() {
            try {
                const dataToSave = {
                    maintenanceData: maintenanceData,
                    openItemsData: openItemsData,
                    openItemsCounter: openItemsCounter,
                    biometricsData: biometricsData,
                    savedReports: savedReports,
                    activeCategories: activeCategories,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('maintenanceDashboardData', JSON.stringify(dataToSave));
                console.log('Data saved to localStorage at', new Date().toLocaleTimeString());
                showAutoSaveIndicator();
            } catch (error) {
                console.error('Error saving data to localStorage:', error);
                showAlert('Error saving data! Please try again.', 'error');
            }
        }

        function showAutoSaveIndicator() {
            const existingIndicator = document.getElementById('autoSaveIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }

            const indicator = document.createElement('div');
            indicator.id = 'autoSaveIndicator';
            indicator.className = 'fixed bottom-6 right-6 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg z-50 flex items-center gap-2 transform transition-all duration-300 translate-y-full';
            indicator.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span class="text-sm font-medium">Data Saved</span>
            `;
            
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                indicator.classList.remove('translate-y-full');
            }, 100);
            
            setTimeout(() => {
                indicator.classList.add('translate-y-full');
                setTimeout(() => {
                    if (document.body.contains(indicator)) {
                        document.body.removeChild(indicator);
                    }
                }, 300);
            }, 2000);
        }

        function startAutoSave() {
            if (!isAutoSaveEnabled) return;
            autoSaveInterval = setInterval(() => {
                saveDataToLocalStorage();
            }, 30000);
        }

        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
        }

        function setupBeforeUnloadSave() {
            window.addEventListener('beforeunload', function(e) {
                saveDataToLocalStorage();
            });
        }

        function setupVisibilityChangeSave() {
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    saveDataToLocalStorage();
                }
            });
        }

        function setupInputAutoSave() {
            const formElements = [
                'requestsInput', 'acknowledgedInput', 'requestRemarksInput',
                'itemsInput', 'rectifiedInput', 'openRequestInput', 'rectificationRemarksInput',
                'biometricsDate', 'biometricsIssuedTo', 'biometricsDepartment', 'biometricsKeyCardNo',
                'biometricsDateReturned', 'biometricsReturnedTo', 'biometricsRemarks'
            ];

            formElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.addEventListener('change', function() {
                        clearTimeout(this.saveTimeout);
                        this.saveTimeout = setTimeout(() => {
                            saveDataToLocalStorage();
                        }, 1000);
                    });
                }
            });
        }

        function loadDataFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('maintenanceDashboardData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    if (data.maintenanceData) {
                        maintenanceData = data.maintenanceData;
                    }
                    if (data.openItemsData) {
                        openItemsData = data.openItemsData;
                    }
                    if (data.openItemsCounter) {
                        openItemsCounter = data.openItemsCounter;
                    }
                    if (data.biometricsData) {
                        biometricsData = data.biometricsData;
                    }
                    if (data.savedReports) {
                        savedReports = data.savedReports;
                    }
                    if (data.activeCategories) {
                        activeCategories = data.activeCategories;
                    }
                    
                    console.log('Data loaded from localStorage');
                    
                    if (data.lastSaved) {
                        const lastSavedDate = new Date(data.lastSaved);
                        console.log('Last saved:', lastSavedDate.toLocaleString());
                        showAlert(`Data loaded! Last saved: ${lastSavedDate.toLocaleString()}`, 'success');
                    }
                    
                    return true;
                }
            } catch (error) {
                console.error('Error loading data from localStorage:', error);
                showAlert('Error loading saved data. Starting fresh.', 'warning');
            }
            return false;
        }

        function updateRectificationCountsFromOpenItems() {
            const rectifiedByMonthCategory = {};
            
            // Count rectified open items by month and category
            Object.values(openItemsData).forEach(item => {
                if (item.status === 'Rectified') {
                    const category = item.category || 'preventive';
                    const month = item.month;
                    
                    if (!rectifiedByMonthCategory[category]) {
                        rectifiedByMonthCategory[category] = {};
                    }
                    if (!rectifiedByMonthCategory[category][month]) {
                        rectifiedByMonthCategory[category][month] = 0;
                    }
                    rectifiedByMonthCategory[category][month]++;
                }
            });
            
            // Update rectification entries automatically
            Object.keys(rectifiedByMonthCategory).forEach(tab => {
                Object.keys(rectifiedByMonthCategory[tab]).forEach(month => {
                    const rectifiedCount = rectifiedByMonthCategory[tab][month];
                    
                    // Find or create appropriate category for auto-updates
                    const autoCategory = 'Open Items (Auto-Sync)';
                    
                    if (!maintenanceData[tab]) {
                        maintenanceData[tab] = { request: {}, rectification: {} };
                    }
                    if (!maintenanceData[tab].rectification[autoCategory]) {
                        maintenanceData[tab].rectification[autoCategory] = {};
                    }
                    
                    // Count total open items for this month/category to get items count
                    const totalItemsForMonth = Object.values(openItemsData).filter(item => 
                        item.month === month && (item.category || 'preventive') === tab
                    ).length;
                    
                    const openItemsForMonth = Object.values(openItemsData).filter(item => 
                        item.month === month && (item.category || 'preventive') === tab && item.status === 'Open'
                    ).length;
                    
                    // Update or create rectification entry
                    maintenanceData[tab].rectification[autoCategory][month] = {
                        items: totalItemsForMonth,
                        rectified: rectifiedCount,
                        open: openItemsForMonth,
                        remarks: `Auto-synced from Open Items Tracker (${rectifiedCount} rectified, ${openItemsForMonth} remaining open)`
                    };
                });
            });
        }

        function showAutoSyncRequestsModal(tab, category, monthYear, requests, acknowledged) {
            const unacknowledged = requests - acknowledged;
            
            if (unacknowledged <= 0) {
                return; // No need to sync if all requests are acknowledged
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
            
            modal.innerHTML = `
                <div class="modal-dialog p-8 max-w-lg w-full mx-4">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-sync-alt text-white text-xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Auto-Sync to Open Items</h3>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900 rounded-lg p-4 mb-6">
                        <p class="text-blue-800 dark:text-blue-200 mb-3">
                            <strong>New Request Entry:</strong>
                        </p>
                        <ul class="text-blue-700 dark:text-blue-300 space-y-1">
                            <li>• Category: ${category}</li>
                            <li>• Month: ${monthYear}</li>
                            <li>• Total Requests: ${requests}</li>
                            <li>• Acknowledged: ${acknowledged}</li>
                            <li>• <strong>Unacknowledged: ${unacknowledged}</strong></li>
                        </ul>
                    </div>
                    
                    <p class="text-gray-700 dark:text-gray-300 mb-6">
                        Would you like to auto-create <strong>${unacknowledged} open items</strong> in the Open Items Tracker? 
                        This will help you track unacknowledged requests until completion.
                    </p>
                    
                    <div class="bg-yellow-50 dark:bg-yellow-900 rounded-lg p-4 mb-6">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-lightbulb text-yellow-600 dark:text-yellow-400"></i>
                            <span class="font-semibold text-yellow-800 dark:text-yellow-200">How Auto-Sync Works:</span>
                        </div>
                        <ul class="text-yellow-700 dark:text-yellow-300 text-sm space-y-1">
                            <li>• Each unacknowledged request becomes an "Open Item"</li>
                            <li>• When you mark open items as "Rectified", rectification counts auto-update</li>
                            <li>• Reports will show synchronized totals between both systems</li>
                            <li>• You can track progress in the Open Items Tracker tab</li>
                        </ul>
                    </div>
                    
                    <div class="flex justify-end gap-4">
                        <button class="px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md font-semibold transition-all duration-300" onclick="this.closest('.fixed').remove()">
                            Skip Auto-Sync
                        </button>
                        <button onclick="performAutoSync('${tab}', '${category}', '${monthYear}', ${requests}, ${acknowledged})" class="btn-primary px-6 py-3 text-white rounded-md font-semibold transition-all duration-300">
                            <i class="fas fa-sync-alt mr-2"></i>Create ${unacknowledged} Open Items
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function performAutoSync(tab, category, monthYear, requests, acknowledged) {
            const unacknowledged = requests - acknowledged;
            let createdCount = 0;
            
            for (let i = 0; i < unacknowledged; i++) {
                const itemId = Date.now().toString() + '_' + i;
                const caseId = `AUTO-${monthYear.replace(' ', '-')}-${category.substring(0, 3).toUpperCase()}-${String(Date.now()).slice(-4)}-${String(i + 1).padStart(2, '0')}`;
                
                openItemsData[itemId] = {
                    id: itemId,
                    caseId: caseId,
                    month: monthYear,
                    category: tab,
                    priority: 'medium',
                    description: `Unacknowledged request from ${category} (Auto-created from maintenance data)`,
                    remarks: `Auto-created during request entry - represents 1 of ${unacknowledged} unacknowledged requests`,
                    dateCreated: new Date().toISOString().split('T')[0],
                    status: 'Open',
                    dateCompleted: null,
                    completionRemarks: null
                };
                createdCount++;
            }
            
            const modal = document.querySelector('.fixed.inset-0.bg-black');
            if (modal) {
                document.body.removeChild(modal);
            }
            
            saveDataToLocalStorage();
            updateOpenItemsTable();
            updateOpenRequestCounts();
            
            showAlert(`✅ Auto-Sync Complete! Created ${createdCount} open items for unacknowledged requests. Go to "Open Items Tracker" to manage them.`, 'success');
        }

        function updateOpenItemsSync() {
            // Update rectification counts when open items are completed
            updateRectificationCountsFromOpenItems();
            updateSyncIndicators();
        }

        function updateSyncIndicators() {
            // Show sync status in reports
            const openItemsSummary = getOpenItemsSummary();
            
            // Update any rectification count displays with sync indicators
            if (openItemsSummary.rectified > 0) {
                console.log(`Open Items Tracker: ${openItemsSummary.rectified} items auto-synced to rectification counts`);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                isDarkMode = true;
                document.documentElement.classList.add('dark');
                document.getElementById('darkModeIcon').className = 'fas fa-sun text-lg';
            }
            
            const dataLoaded = loadDataFromLocalStorage();
            
            updateCategoryDropdowns();
            updateCurrentDataTable();
            updateOpenItemsTable();
            updateBiometricsStats();
            
            switchTab('preventive');
            
            setupBeforeUnloadSave();
            setupVisibilityChangeSave();
            setupInputAutoSave();
            startAutoSave();
            
            if (!dataLoaded) {
                showAlert('Welcome to your enhanced maintenance dashboard! Now includes comprehensive open items tracking and detailed reporting with counts. Default view: 2025 data structure.', 'info');
            }
            
            document.body.style.opacity = '0';
            setTimeout(() => {
                document.body.style.transition = 'opacity 0.3s ease';
                document.body.style.opacity = '1';
            }, 100);
        });

        window.addNewKeyCards = addNewKeyCards;
        window.deleteKeyCard = deleteKeyCard;
        window.addOpenItem = addOpenItem;
        window.markAsRectified = markAsRectified;
        window.editOpenItem = editOpenItem;
        window.deleteOpenItem = deleteOpenItem;
        window.showOpenRequestsModal = showOpenRequestsModal;
        window.performAutoSync = performAutoSync;
    </script>
</body>
</html>